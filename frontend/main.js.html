<script>
  // ==================================================================
  //  SECTION 1: CONFIGURATION & DATA ADAPTERS
  // ==================================================================

    const FIELD_CONFIG = {
    _default: [
      { key: 'title', label: '标题', needTrunc: true, linkField: 'sourceUrl', width: '30%' },
      { key: 'date', label: '日期', width: '10%' }, 
      { key: 'infoA', label: '信息 A', width: '20%' },
      { key: 'infoB', label: '信息 B', width: '10%' }, 
      { key: 'id', label: 'ID', width: '20%' },
    ],
    academicPapers: [
      { key: 'title', label: '技术主题', needTrunc: true, linkField: 'sourceUrl', width: '35%' },
      { key: 'infoA', label: '论文作者', needTrunc: true, width: '20%' }, 
      { key: 'date', label: '发表日期', width: '15%' },
      { key: 'infoB', label: '相关性分', width: '10%' }, 
      { key: 'id', label: '原始ID', needTrunc: true, width: '20%' },
    ],
    patentData: [
      { key: 'title', label: '专利标题', needTrunc: true, linkField: 'sourceUrl', width: '40%' },
      { key: 'infoA', label: '专利号', width: '20%' }, 
      { key: 'date', label: '申请日期', width: '15%' },
      { key: 'infoB', label: '状态', width: '15%' }, 
      { key: 'id', label: 'ID', width: '10%' },
    ],
    openSourceData: [
      { key: 'title', label: '项目名称', needTrunc: true, linkField: 'sourceUrl', width: '30%' },
      { key: 'date', label: '最新提交', width: '15%' },
      { key: 'infoA', label: '技术领域', needTrunc: true, width: '20%' },
      { key: 'infoB', label: '项目简介', needTrunc: true, width: '25%' },
      { key: 'id', label: 'ID', needTrunc: true, width: '10%' },
    ],
    techNews: [
      { key: 'title', label: '新闻标题', needTrunc: true, linkField: 'sourceUrl', width: '40%' },
      { key: 'date', label: '发布日期', width: '15%' },
      { key: 'infoA', label: '新闻来源', width: '15%' },
      { key: 'infoB', label: '新闻简介', needTrunc: true, width: '20%' },
      { key: 'id', label: 'ID', needTrunc: true, width: '10%' },
    ],
    industryDynamics: [
      { key: 'title', label: '事件标题', needTrunc: true, linkField: 'sourceUrl', width: '35%' },
      { key: 'date', label: '事件日期', width: '15%' },
      { key: 'infoA', label: '影响级别', width: '20%' },
      { key: 'infoB', label: '状态', width: '15%' },
      { key: 'id', label: 'ID', needTrunc: true, width: '15%' },
    ],
    techInnovation: [
      { key: 'title', label: '创新点', needTrunc: true, linkField: 'sourceUrl', width: '40%' },
      { key: 'date', label: '更新时间', width: '15%' },
      { key: 'infoA', label: '状态', width: '15%' },
      { key: 'infoB', label: '威胁等级', width: '15%' },
      { key: 'id', label: 'ID', needTrunc: true, width: '15%' },
    ],
    productRelease: [
      { key: 'title', label: '产品名称', needTrunc: true, linkField: 'sourceUrl', width: '40%' },
      { key: 'date', label: '发布时间', width: '15%' },
      { key: 'infoA', label: '状态', width: '15%' },
      { key: 'infoB', label: '', width: '15%' },
      { key: 'id', label: 'ID', needTrunc: true, width: '15%' },
    ],
    talentFlow: [
      { key: 'title', label: '流动事件', needTrunc: true, linkField: 'sourceUrl', width: '40%' },
      { key: 'date', label: '时间', width: '15%' },
      { key: 'infoA', label: '状态', width: '15%' },
      { key: 'infoB', label: '', width: '15%' },
      { key: 'id', label: 'ID', needTrunc: true, width: '10%' },
    ],
    techDomain: [
        { key: 'title', label: '技术名称', width: '30%' }, 
        { key: 'infoA', label: '技术类别', width: '25%' },
        { key: 'infoB', label: '监控状态', width: '15%' }, 
        { key: 'date', label: '创建日期', width: '15%' }, 
        { key: 'id', label: '技术ID', width: '15%' },
    ],
    industryBenchmark: [
        { key: 'title', label: '公司名称', linkField: 'sourceUrl', width: '30%' }, 
        { key: 'infoA', label: '行业类别', width: '25%' },
        { key: 'infoB', label: '威胁等级', width: '15%' }, 
        { key: 'date', label: '上次更新', width: '15%' }, 
        { key: 'id', label: '对手ID', width: '15%' },
    ],
    conference: [
        { key: 'title', label: '会议名称', linkField: 'sourceUrl', width: '30%' }, 
        { key: 'infoA', label: '行业焦点', width: '25%' },
        { key: 'infoB', label: '监控状态', width: '15%' }, 
        { key: 'date', label: '下次活动', width: '15%' }, 
        { key: 'id', label: '会议ID', width: '15%' },
    ],
    historyDetail: [
        { key: 'key', label: '属性', width: '30%' },
        { key: 'value', label: '值', width: '70%' },
    ]
  };

  function formatDateForDisplay(dateString) {
    if (!dateString) return 'N/A';
    try {
      const dateObj = new Date(dateString);
      if (isNaN(dateObj.getTime())) {
        return 'Invalid Date'; // 如果无法解析，返回错误信息
      }
      // 获取年、月、日
      const year = dateObj.getFullYear();
      const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // 月份从0开始，所以+1
      const day = String(dateObj.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    } catch (e) {
      console.error("Error formatting date:", dateString, e);
      return 'Format Error'; // 捕获异常，返回错误信息
    }
  }

  const DataAdapters = {
    // academicPapers 适配器 (RAW_ACADEMIC_PAPERS)
    academicPapers: item => ({
        id: item.id, // 使用原始数据中的 'id' 字段作为表格的 ID
        title: item.title,
        date: formatDateForDisplay(item.publication_date),
        infoA: item.authors,
        // ✅ 使用 AI 生成的字段来显示“相关性分”
        infoB: item.innovation_score !== undefined && item.innovation_score !== null ? item.innovation_score : 'N/A',
        sourceUrl: item.source_url
    }),
    // patentData 适配器 (RAW_PATENT_DATA)
    patentData: item => ({
        id: item.id,
        title: item.title,
        date: formatDateForDisplay(item.application_date),
        infoA: item.patent_number,
        // ✅ 使用 AI 生成的字段
        infoB: item.processing_status + ' | ' + (item.innovation_score_ai !== undefined && item.innovation_score_ai !== null ? item.innovation_score_ai : 'N/A'), // 示例：状态和 AI 创新分
        sourceUrl: item.source_url
    }),
    // openSourceData 适配器 (RAW_OPENSOURCE_DATA)
    openSourceData: item => ({
        id: item.id,
        title: item.project_name,
        date: formatDateForDisplay(item.last_commit_date),
        infoA: item.ai_keywords,
        // ✅ 使用 AI 生成的字段
        infoB: `${item.ai_summary !== undefined && item.ai_summary !== null ? item.ai_summary : 'N/A'}`,
        sourceUrl: item.source_url
    }),
    // techNews 适配器 (RAW_TECH_NEWS)
    techNews: item => ({
        id: item.id,
        title: item.news_title,
        date: formatDateForDisplay(item.publication_date),
        infoA: item.source_platform,
        // ✅ 使用 AI 生成的字段
        infoB: `${item.ai_summary !== undefined && item.ai_summary !== null ? item.ai_summary : 'N/A'}`,
        sourceUrl: item.source_url
    }),
    // industryDynamics 适配器 (RAW_INDUSTRY_DYNAMICS)
    industryDynamics: item => ({
        id: item.id,
        title: item.event_title,
        date: formatDateForDisplay(item.publication_date),
        // ✅ 使用 AI 生成的字段
        infoA: `商业价值: ${item.commercial_value_score_ai !== undefined && item.commercial_value_score_ai !== null ? item.commercial_value_score_ai : 'N/A'}`,
        infoB: item.processing_status,
        sourceUrl: item.source_url
    }),

    // techInnovation, productRelease, talentFlow 适配器 (RAW_COMPETITOR_INTELLIGENCE)
    // 这些类型的数据在 RAW_COMPETITOR_INTELLIGENCE 集合中，通过 intelligence_type 区分
    techInnovation: item => ({
        id: item.id,
        title: item.intelligence_title,
        date: formatDateForDisplay(item.publication_date),
        infoA: item.competitor_name,
        // ✅ 使用 AI 生成的字段
        infoB: `威胁: ${item.threat_level_score !== undefined && item.threat_level_score !== null ? item.threat_level_score : 'N/A'}`,
        sourceUrl: item.source_url
    }),
    productRelease: item => ({
        id: item.id,
        title: item.intelligence_title,
        date: formatDateForDisplay(item.publication_date),
        infoA: item.competitor_name,
        // ✅ 使用 AI 生成的字段
        infoB: `影响: ${item.business_impact_score !== undefined && item.business_impact_score !== null ? item.business_impact_score : 'N/A'}`,
        sourceUrl: item.source_url
    }),
    talentFlow: item => ({
        id: item.id,
        title: item.intelligence_title,
        date: formatDateForDisplay(item.publication_date),
        infoA: item.competitor_name,
        infoB: item.processing_status, // 如果没有特定 AI 字段，可以继续显示 processing_status
        sourceUrl: item.source_url
    }),

    // techDomain, industryBenchmark, conference 适配器 (来自 Config 数据，保持不变)
    techDomain: item => ({ id: item.tech_id, title: item.tech_name, date: formatDateForDisplay(item.created_date), infoA: item.tech_category, infoB: item.monitoring_status, sourceUrl: null }),
    industryBenchmark: item => ({ id: item.competitor_id, title: item.company_name, date: formatDateForDisplay(item.last_updated), infoA: item.industry_category, infoB: item.threat_level, sourceUrl: item.website_url }),
    conference: item => ({ id: item.conference_id, title: item.conference_name, date: formatDateForDisplay(item.next_event_date), infoA: item.industry_focus, infoB: item.monitoring_status, sourceUrl: item.official_website })
};

  // ==================================================================
  //  SECTION 2: UTILITY FUNCTIONS
  // ==================================================================

  function truncate(str, len = 40) { if (str == null) return ''; str = String(str); return str.length > len ? str.slice(0, len) + '...' : str; }
  function handleFailure(error) { const message = error.message || '发生未知错误'; console.error('全局错误处理器捕获到错误:', message, error); alert(`错误: ${message}`); }
  
  function isRelatedToCompany(item, companyFilterName) {
    // ✅ 核心修正：确保 companyFilterName 始终是一个字符串，再进行 trim().toLowerCase()
    const actualFilterName = String(companyFilterName || '').trim(); // 如果是 null/undefined，转为 ""
    
    if (actualFilterName === '' || actualFilterName.toLowerCase() === '所有企业') {
        return true; // 如果筛选条件为空或为“所有企业”，则所有项都通过
    }

    const filterLower = actualFilterName.toLowerCase();

    // 检查 item.competitor_name 字段（通常用于竞争情报）
    if (item.competitor_name && String(item.competitor_name).toLowerCase().includes(filterLower)) {
        return true;
    }

    // 检查 item.related_companies 数组字段（通常用于产业动态）
    if (Array.isArray(item.related_companies)) {
        for (const company of item.related_companies) {
            // 确保 company 也是字符串，再进行 toLowerCase()
            if (String(company || '').toLowerCase().includes(filterLower)) {
                return true;
            }
        }
    }

    return false; // 没有匹配到任何公司
  }


  /**
   * ✅ 核心修改：重写 showHistoryDetailModal，让它使用主渲染引擎
   */
  function showHistoryDetailModal(executionId) {
    App.currentDetailType = 'historyDetail';
    App.allModalData = [];
    App.currentPage = 1;
    App.ui.showDetailListModal(`任务详情: ${executionId}`, 'all');
    document.getElementById('detailTable').innerHTML = '<tbody><tr><td class="text-center p-4">正在加载...</td></tr></tbody>';
    // ✅ 修复：在访问 style 属性前检查 footer 是否存在
    const footer = document.querySelector('#detailModal .modal-footer');
    if (footer) {
        footer.style.display = 'none';
    }

    App.callApi('CollectionStatsService', 'getWorkflowExecutionDetail', [executionId])
      .then(detail => {
        if (detail && !detail.error) {
          App.allModalData = Object.entries(detail).map(([key, value]) => ({
            key: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
            value: value != null ? value : 'N/A'
          }));
          App.ui.renderPagedKpiDetails();
          // ✅ 修复：在访问 style 属性前检查 footer 是否存在
          if (footer) {
            footer.style.display = 'none';
          }
        } else {
          App.allModalData = [{ key: '错误信息', value: detail.error || '未能获取详情。' }];
          App.ui.renderPagedKpiDetails();
          // ✅ 修复：在访问 style 属性前检查 footer 是否存在
          if (footer) {
            footer.style.display = 'none';
          }
        }
      })
      .catch(error => {
        App.allModalData = [{ key: '严重错误', value: error.message }];
        App.ui.renderPagedKpiDetails();
        // ✅ 修复：在访问 style 属性前检查 footer 是否存在
        if (footer) {
            footer.style.display = 'none';
        }
      });
  }

  function setupHamburgerMenu() {
    const hamburgerBtn = document.getElementById('hamburger-menu-btn');
    const mainNav = document.getElementById('main-nav');

    if (hamburgerBtn && mainNav) {
      // 点击汉堡按钮时，只在移动端模式下切换菜单可见性
      hamburgerBtn.addEventListener('click', () => {
        if (window.innerWidth < 768) { // 仅在小屏幕 (<md) 下才响应点击
          mainNav.classList.toggle('hidden');
          mainNav.classList.toggle('flex'); // 切换 flex 类以确保 display:flex
          
          // 切换汉堡图标
          const icon = hamburgerBtn.querySelector('i');
          if (mainNav.classList.contains('hidden')) { // 如果菜单现在是隐藏的
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars'); // 显示汉堡图标
          } else { // 如果菜单现在是显示的
              icon.classList.remove('fa-bars');
              icon.classList.add('fa-times'); // 显示关闭图标
          }
        }
      });

      // 当点击导航链接时，如果菜单是展开的，则自动收起 (仅在移动端)
      mainNav.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth < 768 && mainNav.classList.contains('flex')) { // 如果当前是小屏幕且菜单是展开的
            mainNav.classList.add('hidden');
            mainNav.classList.remove('flex');
            // 恢复汉堡图标
            const icon = hamburgerBtn.querySelector('i');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
      });

      // **核心：处理窗口大小变化，确保 PC 侧始终显示导航，移动侧按需显示汉堡按钮**
      const handleResize = () => {
        if (window.innerWidth >= 768) { // PC 视图 (md 及以上)
          mainNav.classList.remove('hidden'); // 确保导航菜单可见
          mainNav.classList.add('flex');      // 确保导航菜单是 flex 布局
          mainNav.classList.remove('flex-col'); // 移除移动端可能添加的 flex-col
          mainNav.classList.add('flex-row'); // 确保 PC 端是 flex-row

          // 隐藏汉堡菜单按钮
          hamburgerBtn.classList.add('hidden');
          // 确保汉堡按钮图标是初始状态（虽然它被隐藏了，但保持状态一致性）
          const icon = hamburgerBtn.querySelector('i');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');

        } else { // 移动端视图 (小于 md)
          // 确保汉堡菜单按钮可见
          hamburgerBtn.classList.remove('hidden');
          
          // 如果菜单当前处于展开状态（flex），则保持 flex-col
          // 否则，保持 hidden
          if (!mainNav.classList.contains('flex')) { // 如果菜单不是显式展开的
            mainNav.classList.add('hidden');
            mainNav.classList.remove('flex'); // 确保它是 hidden 状态
          }
          mainNav.classList.remove('flex-row'); // 移除 PC 端可能添加的 flex-row
          mainNav.classList.add('flex-col'); // 确保移动端是 flex-col
        }
      };

      // 页面加载时立即执行一次，设置初始状态
      handleResize();
      // 监听窗口大小改变事件，以便在调整浏览器窗口大小时也能正确响应
      window.addEventListener('resize', handleResize);
    }
  }


  // ==================================================================
  //  SECTION 3: CORE APPLICATION LOGIC
  // ==================================================================

  const App = {
    allModalData: [], currentPage: 1, itemsPerPage: 15, currentDetailType: null,
    reportsHistoryCurrentPage: 1,
    reportsHistoryItemsPerPage: 15,
    reportsHistoryTotalPages: 1,
    reportsHistoryTotalRecords: 0,
    // ✅ 新增：洞察线索分页相关状态
    insightsCurrentPage: 1,
    insightsItemsPerPage: 10, // 与后端默认值保持一致
    insightsTotalPages: 1,
    insightsTotalRecords: 0,
    cachedData: {},

    callApi: function(svc, mtd, args = []) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(res => {
            let parsedRes;
            
            // 检查返回的是否是字符串，并且看起来像JSON
            if (typeof res === 'string' && (res.startsWith('{') || res.startsWith('['))) { 
                try {
                    parsedRes = JSON.parse(res);
                    console.log(`SUCCESSFULLY PARSED JSON for [${svc}.${mtd}]. Parsed object:`, parsedRes);
                } catch (e) {
                    console.error(`ERROR: Failed to parse JSON response for [${svc}.${mtd}]:`, e);
                    console.error(`Invalid JSON string was:`, res);
                    reject(new Error(`后端返回的响应无法解析为JSON: ${e.message}`));
                    return;
                }
            } else {
                // 如果不是一个看起来像 JSON 的字符串，直接赋值
                parsedRes = res;
            }

            if (parsedRes === null) {
                reject(new Error("后端返回了意外的null值。"));
            } else if (parsedRes && parsedRes.error) {
                reject(new Error(parsedRes.error));
            } else {
                resolve(parsedRes);
            }
          })
          .withFailureHandler(err => reject(err)) // 确保错误处理器的正确性
          .callApi(svc, mtd, args);
      });
},

    ui: {
      // ✅ 修改：为表格单元格添加 data-label 属性以支持移动端
      renderPagedKpiDetails: function() {
        // ✅ 防御性检查：确保所有必需的DOM元素都存在
        const table = document.getElementById('detailTable');
        const footer = document.querySelector('#detailModal .modal-footer');
        const noData = document.getElementById('noDataMessage');
        const modalBodyContent = document.querySelector('#detailModal .p-6.overflow-y-auto'); // 模态框内容区域

        if (!table || !noData || !modalBodyContent || !footer) { // 检查所有关键元素，包括footer
            console.error("ERROR: 模态框内部关键DOM元素缺失 (detailTable, noDataMessage, modalBodyContent, 或 modal-footer)。");
            return; // 无法继续渲染
        }

        // 清除之前可能存在的旧内容和状态
        table.innerHTML = '';
        noData.style.display = 'none';
        footer.style.display = 'none'; // 默认隐藏，稍后根据需要显示
        // 移除之前可能添加的证据链部分
        const existingEvidenceChainSection = modalBodyContent.querySelector('.evidence-chain-section');
        if (existingEvidenceChainSection) {
            existingEvidenceChainSection.remove();
        }

        if (!App.allModalData || App.allModalData.length === 0) {
            noData.style.display = 'block';
            return;
        }

        // --- 特殊处理：洞察详情 (historyDetail) ---
    if (App.currentDetailType === 'historyDetail') {
        const insightDetailData = App.allModalData; // App.allModalData 此时就是单个洞察的键值对数组
        let evidenceChainHtml = '';

        // ✅ 核心修正：直接从原始数据中查找 'evidence_chain' 字段
        // App.allModalData 已经是格式化后的键值对数组，所以我们需要从原始的 insightDetail 对象中寻找
        // 假设 App.allModalData[0].originalObject 存储了原始对象
        // 实际上，App.allModalData 是通过 Object.entries(insightDetail).map(...) 构造的，
        // 所以 insightDetailData 就是那个经过 key 格式化后的数组。
        // 我们需要回到源头，即 App.callApi 返回的 insightDetail 对象
        // 解决办法是在 App.callApi 的回调里直接传递原始对象给 renderPagedKpiDetails

        // 为了简化和即时修复，我们假设 insightDetailData 中会有一个 key 叫做 'evidence_chain' (小写带下划线)
        // 或者我们可以在这里重新从原始的 insightDetail 对象中提取
        // 考虑到 App.allModalData 已经是 Object.entries 转换后的数组，
        // 我们需要找到原始的 'evidence_chain' 键所对应的条目
        // ✅ 修改为：直接查找格式化后的键名 'Evidence Chain'
        const rawEvidenceChainEntry = insightDetailData.find(item => item.key === 'Evidence Chain');

        console.log("DEBUG_EVIDENCE_CHAIN: Found rawEvidenceChainEntry:", rawEvidenceChainEntry);


        // 如果存在 evidence_chain 并且它是一个非空数组
        if (rawEvidenceChainEntry && Array.isArray(rawEvidenceChainEntry.value) && rawEvidenceChainEntry.value.length > 0) {
            evidenceChainHtml = `
              <div class="mt-6 border-t pt-4 evidence-chain-section">
                  <h4 class="font-semibold text-lg mb-3 text-gray-800">证据链 (Evidence Chain)</h4>
                  <div class="space-y-3">
                      ${rawEvidenceChainEntry.value.map(evidenceString => {
                          let evidence = {};
                          try {
                              if (typeof evidenceString === 'string') {
                                  evidence = JSON.parse(evidenceString);
                              } else {
                                  evidence = evidenceString;
                              }
                          } catch (e) {
                              console.error("Failed to parse evidence chain item JSON:", e, evidenceString);
                              return `<div class="bg-red-100 p-2 rounded-md text-red-700">错误: 证据链数据解析失败，原始数据: ${String(evidenceString).substring(0, 100)}...</div>`;
                          }

                          // ✅ 核心修改：直接使用 window.open 在 onclick 事件中
                          // 移除了 google.script.run 调用，直接使用 JavaScript 的 window.open
                          const urlToOpen = evidence.source_url || '#';
                          const linkHtml = urlToOpen !== '#' ?
                              `<span class="text-blue-600 hover:underline cursor-pointer" onclick="window.open('${urlToOpen}', '_blank');">${evidence.title || 'N/A'}</span>` :
                              `<span class="text-gray-600">${evidence.title || 'N/A'}</span>`; // 如果没有URL，则不可点击

                          return `
                              <div class="bg-gray-100 p-3 rounded-md border border-gray-200">
                                  <p class="text-sm font-medium text-gray-700">来源类型: <span class="font-normal">${evidence.source_type || 'N/A'}</span></p>
                                  <p class="text-sm font-medium text-gray-700">标题: ${linkHtml}</p>
                                  <p class="text-xs text-gray-500">原始ID: ${evidence.id || 'N/A'}</p>
                                  ${evidence.publication_date ? `<p class="text-xs text-gray-500">发布日期: ${new Date(evidence.publication_date).toISOString().split('T')[0]}</p>` : ''}
                                  ${evidence.last_update_timestamp ? `<p class="text-xs text-gray-500">更新日期: ${new Date(evidence.last_update_timestamp).toISOString().split('T')[0]}</p>` : ''}
                                  ${evidence.competitor_name ? `<p class="text-xs text-gray-500">公司名称: ${evidence.competitor_name}</p>` : ''}
                              </div>
                          `;
                      }).join('')}
                  </div>
              </div>
          `;
        }

        // 渲染主要洞察详情表格
        let theadHTML_insight = `<thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">属性</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/3">值</th></tr></thead>`;
        let tbodyHTML_insight = `<tbody class="bg-white divide-y divide-gray-200">
            ${insightDetailData.map(item => { // 使用 insightDetailData
                // 将 evidence_chain 从主表中排除，因为它将单独渲染
                if (item.key === 'Evidence Chain') return '';

                let displayValue = item.value;
                // 格式化日期对象或 ISO 字符串以获得更好的显示效果
                if (typeof item.value === 'string' && (item.value.match(/^\d{4}-\d{2}-\d{2}T\d{2}:?\d{2}:?\d{2}/) || item.value.match(/^\d{4}-\d{2}-\d{2}$/))) {
                    try {
                        const d = new Date(item.value);
                        if (!isNaN(d.getTime())) {
                            displayValue = d.toLocaleString(); // 使用本地化日期/时间
                        }
                    } catch (e) { /* 忽略 */ }
                } else if (typeof item.value === 'object' && item.value instanceof Date) {
                    displayValue = item.value.toLocaleString();
                } else if (Array.isArray(item.value)) {
                    displayValue = item.value.map(val => {
                        if (typeof val === 'object' && val !== null) {
                            return val.name || val.title || JSON.stringify(val);
                        }
                        return val;
                    }).join(', ');
                } else if (typeof item.value === 'object' && item.value !== null) {
                    displayValue = JSON.stringify(item.value, null, 2);
                }

                // ✅ 确保长文本能够换行显示
                // 这里不需要重复判断 typeof item.value === 'object'，因为上面已经处理过了
                // 对于 Source Url 这样的链接，也需要确保 break-all
                if (item.key === 'Source Url' && typeof item.value === 'string' && item.value.startsWith('http')) {
                    displayValue = `<a href="${item.value}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline break-all">${item.value}</a>`;
                }

                return `
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900" data-label="${item.key}">${item.key}</td>
                        <td class="px-6 py-4 text-sm text-gray-800" data-label="值">
                            <pre style="white-space: pre-wrap; word-break: break-word;">${displayValue}</pre>
                        </td>
                    </tr>
                `;
            }).join('')}
        </tbody>`;

        table.innerHTML = theadHTML_insight + tbodyHTML_insight;

        // 将证据链 HTML 附加到 modalBodyContent 的末尾
        if (evidenceChainHtml) {
            modalBodyContent.insertAdjacentHTML('beforeend', evidenceChainHtml);
        }

        // 洞察详情没有分页，所以隐藏分页控件
        footer.style.display = 'none';
        return;
    }

        // --- 通用 KPI 详情处理 (如果有分页) ---
        const totalItems = App.allModalData.length;
        const totalPages = Math.ceil(totalItems / App.itemsPerPage);
        const pageData = App.allModalData.slice((App.currentPage - 1) * App.itemsPerPage, App.currentPage * App.itemsPerPage);

        const displayFields = FIELD_CONFIG[App.currentDetailType] || FIELD_CONFIG._default || [];
        let theadHTML = `<thead class="bg-gray-50"><tr>${
            displayFields.map(f => {
                const style = f.width ? `style="width: ${f.width};"` : '';
                return `<th ${style} class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">${f.label}</th>`;
            }).join('')
        }</tr></thead>`;
        
        let tbodyHTML = `<tbody class="bg-white divide-y divide-gray-200">${
            pageData.map(item => `<tr>${
                displayFields.map(f => {
                    const rawValue = item[f.key];
                    let displayValue = rawValue !== null ? String(rawValue) : 'N/A';
                    // *** 在这里添加以下日志行 ***
                    //console.log(`DEBUG_RENDER: 字段: ${f.key}, 原始值 (rawValue):`, rawValue, `显示值 (displayValue):`, displayValue);

                    if (f.linkField && item[f.linkField]) {
                        const truncatedText = f.needTrunc ? truncate(displayValue) : displayValue;
                        displayValue = `<a href="${item[f.linkField]}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline">${truncatedText}</a>`;
                    } else if (f.needTrunc) {
                        displayValue = truncate(displayValue);
                    }
                    const tdStyle = f.width ? `style="width: ${f.width};"` : '';
                    return `<td class="px-6 py-4 text-sm text-gray-800" ${tdStyle} data-label="${f.label}">
                                <div class="whitespace-nowrap overflow-hidden text-ellipsis" title="${String(rawValue || '').replace(/"/g, '&quot;')}">
                                    ${displayValue}
                                </div>
                            </td>`;
                }).join('')
            }</tr>`).join('')
        }</tbody>`;

        table.innerHTML = theadHTML + tbodyHTML;
        document.getElementById('paginationInfo').textContent = `第 ${App.currentPage} / ${totalPages} 页 (共 ${totalItems} 条)`;
        document.getElementById('prevPageBtn').disabled = App.currentPage === 1;
        document.getElementById('nextPageBtn').disabled = App.currentPage === totalPages;

        // 显示分页控件
        footer.style.display = 'flex';
      },

      prevInsightsPage: function() {
          if (App.insightsCurrentPage > 1) {
              App.insightsCurrentPage--;
              App.pageInitializers.insights.loadLatestInsightsTable();
          }
      },
      nextInsightsPage: function() {
          if (App.insightsCurrentPage < App.insightsTotalPages) {
              App.insightsCurrentPage++;
              App.pageInitializers.insights.loadLatestInsightsTable();
          }
      },

      showDetailListModal: function(title, detailKind) {
        document.getElementById('modalTitle').textContent = `${title} - ${detailKind === 'today' ? '近7日明细' : '全部明细'}`;
        const detailModal = document.getElementById('detailModal');
        if (detailModal) { // 确保 detailModal 存在才操作
            detailModal.style.display = 'flex'; 
        } else {
            console.error("ERROR: 无法找到 detailModal 元素。");
            return; // 无法显示模态框，直接返回
        }
        
        // ✅ 修复：将渲染内容推迟到下一个事件循环，确保DOM稳定
        setTimeout(() => {
            this.renderPagedKpiDetails();
        }, 0);
      },
      handleCollectionCardClick: function(e, pageData) {
        const card = e.target.closest('.clickable-kpi');
        if (!card) return;
        const type = card.dataset.type;
        const adapter = DataAdapters[type];
        if (!type || !adapter) return console.error(`未找到类型 "${type}" 的适配器`);
        const detailEl = e.target.closest('.clickable-detail');
        const detailKind = detailEl ? detailEl.dataset.detail : 'all';
        const title = card.querySelector('h3').innerText;
        App.currentDetailType = type;
        App.currentPage = 1;
        let rawData = [];
        if (pageData.techData && pageData.techData[type]) {
            rawData = pageData.techData[type];
        } else if (type === 'industryDynamics') {
            const ind = (pageData.benchmarkData.industryDynamics || []).filter(item => !pageData.competitorName || String(item.competitor_name || '').toLowerCase().includes(pageData.competitorName));
            const ciNews = (pageData.benchmarkData.competitorIntelligence || []).filter(item => (!pageData.competitorName || String(item.competitor_name || '').toLowerCase().includes(this.competitorName)) && (item.intelligence_type || '').toLowerCase().replace(/[\s_]/g, '') === 'generalnews')
                .map(item => ({ event_title: item.intelligence_title, event_date: item.last_update_timestamp, impact_level: item.threat_level, processing_status: item.processing_status, source_url: item.source_url }));
            rawData = [...ind, ...ciNews];
        } else {
            const typeMapping = { 'techInnovation': 'Tech Innovation', 'productRelease': 'Product Release', 'talentFlow': 'Talent Flow' };
            if (typeMapping[type]) rawData = (pageData.benchmarkData.competitorIntelligence || []).filter(item => (!pageData.competitorName || String(item.competitor_name || '').toLowerCase().includes(this.competitorName)) && item.intelligence_type === typeMapping[type]);
        }
        let dataToAdapt = rawData;
        if (detailKind === 'today') {
            const dateFieldMap = { academicPapers: 'publication_date', patentData: 'application_date', openSourceData: 'last_update_timestamp', techNews: 'publication_date', industryDynamics: 'event_date', techInnovation: 'last_update_timestamp', productRelease: 'last_update_timestamp', talentFlow: 'last_update_timestamp' };
            const dateField = dateFieldMap[type] || 'created_timestamp';
            const todayStr = new Date().toISOString().slice(0, 10);
            dataToAdapt = rawData.filter(item => { const val = item[dateField]; return val && String(val).slice(0, 10) === todayStr; });
        }
        App.allModalData = dataToAdapt.map(adapter);
        App.ui.showDetailListModal(title, detailKind);
      },
      handleDashboardKpiClick: async function(event) {
        try{
          console.log("DEBUG_MIN: handleDashboardKpiClick triggered."); 
          const card = event.currentTarget;
          const type = card.dataset.type;
          const adapter = DataAdapters[type];
          if (!type || !adapter) return console.error(`未找到类型 "${type}" 的适配器`);
          App.currentDetailType = type;
          App.currentPage = 1;
          const title = card.querySelector('.kpi-card-title').innerText;
          document.getElementById('modalTitle').textContent = `${title} - 正在加载...`;
          document.getElementById('detailTable').innerHTML = '<tbody><tr><td colspan="5" class="text-center py-8">正在加载...</td></tr></tbody>';
          document.getElementById('noDataMessage').style.display = 'none';
          document.querySelector('#detailModal .modal-footer').style.display = 'none';
          document.getElementById('detailModal').style.display = 'flex';
          const methodMap = { techDomain: 'getTechnologyDomainDetails', industryBenchmark: 'getIndustryBenchmarkDetails', conference: 'getConferenceDetails' };
          const method = methodMap[type];
          if (!method) { handleFailure(new Error(`未为类型 "${type}" 配置后端方法`)); return App.ui.hideDetailModal(); }
          try {
              const rawData = await App.callApi('ConfigDataService', method);
              App.allModalData = rawData.map(adapter);
              App.ui.showDetailListModal(title, 'all');
          } catch (e) { handleFailure(e); App.ui.hideDetailModal(); }
        } catch (outerError) { // ✅ 捕获任何在此函数内部发生的未被内部 try...catch 捕获的错误
          console.error(`FATAL ERROR: handleDashboardKpiClick - Unhandled error in event handler:`, outerError);
          handleFailure(outerError); // 确保任何错误都被报告给用户
          App.ui.hideDetailModal();
        }
      },
      prevPage: function() { if (App.currentPage > 1) { App.currentPage--; App.ui.renderPagedKpiDetails(); } },
      nextPage: function() { if (App.currentPage < Math.ceil(App.allModalData.length / App.itemsPerPage)) { App.currentPage++; App.ui.renderPagedKpiDetails(); } },
      hideDetailModal: function() { document.getElementById('detailModal').style.display = 'none'; }
    },
    init: function() {
      const trendChartDom = document.getElementById('trend-chart-container');
      const keywordChartDom = document.getElementById('keyword-cloud-container');
      const hypeCycleDom = document.getElementById('hype-cycle-chart-container');
      // **新增：知识图谱容器**
      const knowledgeGraphChartDom = document.getElementById('knowledge-graph-container'); 

      console.log('trendChartDom:', trendChartDom);
      console.log('keywordChartDom:', keywordChartDom);
      console.log('hypeCycleDom:', hypeCycleDom);
      console.log('knowledgeGraphChartDom:', knowledgeGraphChartDom); // 打印新图表容器

      const modal = document.getElementById('detailModal');
      modal.querySelector('.close-button').addEventListener('click', this.ui.hideDetailModal);
      modal.addEventListener('click', e => { if (e.target.id === 'detailModal') this.ui.hideDetailModal(); });
      document.getElementById('prevPageBtn').addEventListener('click', this.ui.prevPage);
      document.getElementById('nextPageBtn').addEventListener('click', this.ui.nextPage);
      document.querySelectorAll('.nav-link').forEach(l => l.addEventListener('click', e => { e.preventDefault(); this.switchPage(e.currentTarget.dataset.page); }));
      setupHamburgerMenu(); 
      this.switchPage('home');
      document.getElementById('loader').style.display = 'none';

      // ✅ 新增：为新导航链接添加事件监听
      document.querySelector('.nav-link[data-page="system"]').addEventListener('click', e => { e.preventDefault(); this.switchPage('system'); });

      console.log("✅ App has been initialized successfully!");
    },
    switchPage: async function(pageId) {
      document.querySelectorAll('.nav-link').forEach(l => {
          const isSelected = l.dataset.page === pageId;
          l.classList.remove('bg-black/30', 'shadow-inner', 'bg-primary', 'bg-white/10');
          if (isSelected) {
              l.classList.add('bg-black/30', 'shadow-inner');
          } else {
              l.classList.add('bg-white/10');
          }
      });

      document.querySelectorAll('.page-container').forEach(p => {
          p.classList.toggle('hidden', p.id !== `page-${pageId}`);
      });

      const activePageElement = document.getElementById(`page-${pageId}`);
      if (activePageElement) {
          void activePageElement.offsetWidth;
      }

      const pageInitializer = this.pageInitializers[pageId];
      if (pageInitializer && typeof pageInitializer.init === 'function') {
          // 使用 await 等待页面初始化函数（可能是异步的）完成
          await pageInitializer.init();
      }
    },
    pageInitializers: {
      home: {
        isInitialized: false,
        sankeyChart: null, // ✅ 新增：用于存储桑基图的ECharts实例
        init: async function() {
            console.log('正在初始化主页...');
            if (!this.isInitialized) {
                document.querySelectorAll('#page-home .kpi-card.clickable-kpi').forEach(c => c.addEventListener('click', App.ui.handleDashboardKpiClick));
                this.isInitialized = true;
            }
            try {
                document.querySelectorAll('#page-home .kpi-value, #page-home .kpi-today-update, #page-home .status-percentage, #page-home .kpi-category-value').forEach(el => el.classList.add('skeleton'));
                
                // ✅ 核心修正：使用 Promise.allSettled 来处理部分失败的情况
                const results = await Promise.allSettled([
                    App.callApi('RawDataStatsService', 'getStats'),
                    App.callApi('InsightLeadStatsService', 'getStats'),
                    App.callApi('ConfigDataService', 'getTechnologyDomainStats'),
                    App.callApi('ConfigDataService', 'getIndustryBenchmarkStats'),
                    App.callApi('ConfigDataService', 'getConferenceStats'),
                    App.callApi('SystemHealthStatsService', 'getStats'),
                    App.callApi('SystemAdminService', 'getSankeyData')
                ]);
                
                // ✅ 从 results 数组中安全地提取数据
                const rawData = results[0].status === 'fulfilled' ? results[0].value : { total: 0, sevenDayIngestion: 0, categories: {} };
                const insightLeads = results[1].status === 'fulfilled' ? results[1].value : { total: 0, sevenDayNew: 0, status: {} };
                const techDomains = results[2].status === 'fulfilled' ? results[2].value : { total: 0, active: 0 };
                const benchmarks = results[3].status === 'fulfilled' ? results[3].value : { total: 0, focus: 0 };
                const conferences = results[4].status === 'fulfilled' ? results[4].value : { total: 0, monitoring: 0 };
                const health = results[5].status === 'fulfilled' ? results[5].value : { overall: 0, workflow: 0, dataQuality: 0, alerts: [] };
                const sankeyData = results[6].status === 'fulfilled' ? results[6].value : null; // ✅ 新增: 获取桑基图数据

                // 检查是否有任何 API 调用失败，并在控制台打印日志
                results.forEach((result, index) => {
                    if (result.status === 'rejected') {
                        console.error(`API 调用失败 (索引 ${index}):`, result.reason);
                    }
                });
                
                // --- 后续的渲染逻辑现在是正确的 ---
                if (rawData) {
                    document.getElementById('rawDataTotal').textContent = (rawData.total || 0).toLocaleString();
                    document.getElementById('rawDataTodayUpdate').textContent = `近7日: ${(rawData.sevenDayIngestion || 0).toLocaleString()}`; 
                    const RAWDATA_CATEGORY_ORDER = [ { key: 'academicPapers', label: '论文' }, { key: 'techNews', label: '新闻' }, { key: 'industryDynamics', label: '会议' }, { key: 'patentData', label: '专利' }, { key: 'openSourceData', label: '开源' }, { key: 'competitorIntelligence', label: '竞情' } ];
                    document.getElementById('rawDataCategories').innerHTML = rawData.categories ? RAWDATA_CATEGORY_ORDER.map(cat => `<div class="kpi-category-item bg-gray-100 px-3 py-1 rounded-md text-sm"><span class="kpi-category-value font-semibold">${(rawData.categories[cat.key] || 0).toLocaleString()}</span> ${cat.label}</div>`).join('') : '';
                }

                if (insightLeads) {
                    document.getElementById('insightLeadTotal').textContent = (insightLeads.total || 0).toLocaleString();
                    document.getElementById('insightLeadTodayUpdate').textContent = `近7日: ${(insightLeads.sevenDayNew || 0).toLocaleString()}`; 
                    const INSIGHT_CATEGORY_LABELS = { pending: '待处理', processing: '处理中', completed: '已完成', published: '已发布' };
                    document.getElementById('insightLeadCategories').innerHTML = insightLeads.status ? Object.entries(insightLeads.status).map(([k,v]) => `<div class="kpi-category-item bg-gray-100 px-3 py-1 rounded-md text-sm"><span class="kpi-category-value font-semibold">${v || 0}</span> ${INSIGHT_CATEGORY_LABELS[k] || k}</div>`).join('') : '';
                }
                
                if(techDomains) {
                    document.getElementById('techDomainTotal').textContent = techDomains.total || 0;
                    document.getElementById('techDomainActive').textContent = `活跃: ${techDomains.active || 0}`;
                }
                
                if (benchmarks) {
                    document.getElementById('industryBenchmarkTotal').textContent = benchmarks.total || 0;
                    document.getElementById('industryBenchmarkFocus').textContent = `重点: ${benchmarks.focus || 0}`;
                }

                if (conferences) {
                    document.getElementById('conferenceTotal').textContent = conferences.total || 0;
                    document.getElementById('conferenceMonitoring').textContent = `监控中: ${conferences.monitoring || 0}`;
                }
                
                if (health && health.alerts) {
                    document.getElementById('overallHealthPct').textContent = `${health.overall || 0}%`;
                    document.getElementById('overallHealthBar').style.width = `${health.overall || 0}%`;
                    document.getElementById('workflowHealthPct').textContent = `${health.workflow || 0}%`;
                    document.getElementById('workflowHealthBar').style.width = `${health.workflow || 0}%`;
                    document.getElementById('dataQualityPct').textContent = `${health.dataQuality || 0}%`;
                    document.getElementById('dataQualityBar').style.width = `${health.dataQuality || 0}%`;
                }
                
                // ✅ 新增: 调用桑基图渲染函数
                if (sankeyData) {
                    this.renderSankeyChart(sankeyData);
                } else {
                    document.getElementById('sankey-chart-container').innerHTML = '<div class="text-red-500">加载数据流图失败。</div>';
                }

                document.querySelectorAll('#page-home .skeleton').forEach(el => el.classList.remove('skeleton'));
            } catch(e) { 
                handleFailure(e); 
            }
          },
          // ✅ 用下面的最终版本替换整个 renderSankeyChart 函数
          renderSankeyChart: function(data) {
            const chartContainer = document.getElementById('sankey-chart-container');
            const topLabelsContainer = document.getElementById('sankey-labels-top');
            const bottomLabelsContainer = document.getElementById('sankey-labels-bottom');
            
            if (!chartContainer || !topLabelsContainer || !bottomLabelsContainer) {
                console.error("Sankey Chart: 关键HTML容器缺失。");
                return;
            }

            // 清空旧内容
            topLabelsContainer.innerHTML = '';
            bottomLabelsContainer.innerHTML = '';
            chartContainer.innerHTML = '';

            if (this.sankeyChart && !this.sankeyChart.isDisposed()) {
                this.sankeyChart.dispose();
            }
            this.sankeyChart = echarts.init(chartContainer);

            if (!data || data.error || !Array.isArray(data.nodes) || !Array.isArray(data.links)) {
                const errorMessage = data ? data.error : "从后端接收到的数据无效。";
                console.error("Sankey Chart Error:", errorMessage);
                chartContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center text-red-500 text-sm p-4">${errorMessage}</div>`;
                return;
            }
            if (data.nodes.length === 0) {
                 chartContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-500 text-sm">暂无数据可供可视化。</div>`;
                 return;
            }

            // --- 动态生成 HTML 标签 ---
            const allNodesData = data.nodes;
            
            // ✅ 核心修改: 分离处理顶部标签和底部标签
            const topNodes = allNodesData.filter(n => n.name !== '过滤归档');
            const bottomNode = allNodesData.find(n => n.name === '过滤归档');

            // 处理顶部标签
            topNodes.forEach(node => {
                const labelDiv = document.createElement('div');
                labelDiv.className = 'absolute';
                labelDiv.style.top = '0';
                labelDiv.style.left = `${node.x}%`;
                labelDiv.style.transform = 'translateX(-50%)';
                labelDiv.style.textAlign = 'center';
                labelDiv.style.width = '120px';
                
                labelDiv.innerHTML = `
                    <span class="text-sm text-gray-500">${node.name}</span><br/>
                    <span class="text-xl font-bold text-gray-900">${(node.value || 0).toLocaleString()}</span>
                `;
                topLabelsContainer.appendChild(labelDiv);
            });

            // 处理底部标签
            if (bottomNode) {
                 const labelDiv = document.createElement('div');
                 labelDiv.className = 'absolute';
                 labelDiv.style.bottom = '0'; // 紧贴底部
                 labelDiv.style.left = `${bottomNode.x}%`; // 使用其X坐标定位
                 labelDiv.style.transform = 'translateX(-50%)'; // 居中对齐
                 labelDiv.style.textAlign = 'center';
                 labelDiv.style.width = '120px';

                 labelDiv.innerHTML = `<span class="text-xs text-gray-500">${bottomNode.name} (${(bottomNode.value || 0).toLocaleString()})</span>`;
                 bottomLabelsContainer.appendChild(labelDiv);
            }

            // --- ECharts 配置 (保持不变) ---
            const nodeColors = {
                '数据采集': '#2c3e50',
                '线索识别': '#3498db',
                '证据验证': '#1abc9c',
                '深度分析': '#f1c40f',
                '洞察产出': '#5f27cd',
                '过滤归档': '#95a5a6'
            };
            
            const nodesWithStyle = allNodesData.map(node => ({
                ...node,
                itemStyle: { color: nodeColors[node.name] || '#ccc' }
            }));

            const mainFlowColor = 'rgba(76, 89, 106, 0.4)';    // 深灰蓝色，带有透明度
            const filteredFlowColor = 'rgba(189, 195, 199, 0.6)';
            const linksWithStyle = data.links.filter(link => link.value > 0).map(link => ({
                ...link,
                lineStyle: {
                    color: link.target === '被过滤/归档' ? filteredFlowColor : mainFlowColor
                }
            }));

            const option = {
                backgroundColor: 'transparent',
                tooltip: { show: false },
                series: [{
                    type: 'sankey',
                    layout: 'none',
                    data: nodesWithStyle,
                    links: linksWithStyle,
                    emphasis: { focus: 'adjacency' },
                    nodeWidth: 3,
                    label: { show: false },
                    edgeLabel: { show: false },
                    left: '0.5%',
                    right: '0.5%',
                    top: '10%',
                    bottom: '10%'
                }]
            };

            if (linksWithStyle.length > 0) {
                this.sankeyChart.setOption(option);
            } else {
                console.warn("Sankey Chart: 没有有效的数据流（所有连接值为0），不渲染桑基图。");
                chartContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-500 text-sm">暂无数据流信息。</div>`;
            }

            window.addEventListener('resize', () => {
                if (this.sankeyChart && !this.sankeyChart.isDisposed()) {
                    this.sankeyChart.resize();
                }
            });
        }
      },
      collection: {
        isInitialized: false,
        activeTab: 'overview', // 默认激活的标签页
        scrollObserver: null,
        pageData: null, // 用于缓存从后端获取的数据
        competitorName: '',
        elements: {}, // 缓存DOM元素

      init: function() {
        console.log('正在初始化数据采集与工作流页面...');
        if (!this.isInitialized) {
          // Event listeners for tabs and pageContainer are bound once
          this.elements.tabsContainer = document.getElementById('collection-tabs');
          this.elements.pageContainer = document.getElementById('page-collection');
          this.elements.tabsContainer.addEventListener('click', this.handleTabClick.bind(this));
          this.elements.pageContainer.addEventListener('click', this.handlePageClick.bind(this));
          
          this.isInitialized = true;
        }
        this.updateTabStyles();
        this.loadActiveTabContent();
      },

        // 处理标签页导航的点击事件
        handleTabClick: function(event) {
          const link = event.target.closest('a.collection-tab');
          if (!link) return;
          event.preventDefault();
          const tabName = link.dataset.tab;
          if (tabName === this.activeTab) return;
          this.activeTab = tabName;
          this.updateTabStyles();
          this.loadActiveTabContent();
        },

        // 根据激活的标签页加载对应内容
        loadActiveTabContent: function() {
          if (this.activeTab === 'overview') {
            this.renderOverview();
          } else if (this.activeTab === 'workflows') {
            this.renderWorkflows();
            this.setupScrollObserver();
          }
        },
        
        // 更新标签页的高亮样式
        updateTabStyles: function() {
          document.querySelectorAll('.collection-tab').forEach(tab => {
              const isSelected = tab.dataset.tab === this.activeTab;
              tab.classList.toggle('border-primary', isSelected);
              tab.classList.toggle('text-primary', isSelected);
              tab.classList.toggle('border-transparent', !isSelected);
              tab.classList.toggle('text-gray-500', !isSelected);
          });
          document.querySelectorAll('.tab-content').forEach(content => {
              content.classList.toggle('hidden', content.id !== `tab-content-${this.activeTab}`);
          });
        },
        
        // 统一的页面点击事件委托处理器
        handlePageClick: function(event) {
            if (this.activeTab === 'overview') {
                // 检查是否点击了数据源卡片
                const overviewCard = event.target.closest('.clickable-kpi');
                if (overviewCard) {
                    // ✅ 将 this.pageData 作为参数传递
                    this.handleOverviewCardClick(event, this.pageData); 
                    return; // 处理完毕，退出函数
                }

                // ✅ 核心修正: 检查是否点击了历史记录的“查看详情”按钮
                const historyDetailButton = event.target.closest('.view-history-detail-btn');
                if (historyDetailButton && historyDetailButton.dataset.executionId) {
                    showHistoryDetailModal(historyDetailButton.dataset.executionId);
                    return; // 处理完毕，退出函数
                }

            } else if (this.activeTab === 'workflows') {
                const workflowButton = event.target.closest('button[data-wffunction]');
                const navLink = event.target.closest('a.workbench-nav-link');
                if (workflowButton) {
                    this.handleWorkflowRunClick(workflowButton);
                } else if (navLink) {
                    event.preventDefault();
                    const targetId = navLink.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        const headerOffset = 150;
                        const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
                        window.scrollTo({ top: elementPosition - headerOffset, behavior: "smooth" });
                    }
                }
            }
        },

        // --- “数据源概览”标签页的逻辑 ---
        renderOverview: async function() {
          const container = document.getElementById('tab-content-overview');
          
          // ✅ 核心修正: 提供完整的HTML骨架，包含所有四个部分和筛选器
          const fullHTML = `
            <!-- Section 1: 技术数据采集 -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-8">
              <div class="flex items-center mb-6 border-b pb-4">
                <i class="fa fa-cogs text-xl text-primary mr-3"></i>
                <h3 class="text-xl font-bold text-gray-800">技术数据</h3>
                <span class="ml-4 text-sm text-gray-500">关注全球技术动态，捕捉前沿技术信号</span>
              </div>
              <div id="tech-data-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="skeleton h-56 rounded-lg col-span-full"></div>
              </div>
            </div>

            <!-- Section 2: 标杆数据采集 -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-8">
              <div class="flex items-center mb-6 border-b pb-4">
                <i class="fa fa-flag-checkered text-xl text-primary mr-3"></i>
                <h3 class="text-xl font-bold text-gray-800">标杆数据</h3>
                <span class="ml-4 text-sm text-gray-500">追踪标杆企业动态，洞察产业发展趋势</span></span>
              </div>

              <!-- ✅ 新增: 筛选器UI的HTML结构 -->
              <div class="bg-white p-4 rounded-lg border border-gray-200 mb-6 shadow-sm">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-y-2">
                  <!-- 左侧部分：标签和下拉框 -->
                  <div class="flex items-center space-x-4">
                    <label for="company-select" class="text-sm font-medium text-gray-700 whitespace-nowrap">筛选企业:</label>
                    <select id="company-select" class="flex-grow md:flex-grow-0 md:w-64 p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary text-sm">
                      <option value="">所有企业</option>
                    </select>
                  </div>
                  <!-- 右侧部分：状态文本 -->
                  <p id="filter-status-text" class="text-xs md:text-sm text-gray-500 md:text-right">显示所有企业的数据</p>
                </div>
              </div>
              
              <div id="benchmark-data-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                 <div class="skeleton h-56 rounded-lg col-span-full"></div>
              </div>
              
            </div>
            
            <!-- Section 3: 采集统计 -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-8">
              <div class="flex items-center mb-6 border-b pb-4">
                <i class="fa fa-line-chart text-xl text-primary mr-3"></i>
                <h3 class="text-xl font-bold text-gray-800">采集统计</h3>
              </div>
              <div id="collection-stats-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="skeleton h-24 rounded-lg"></div>
                <div class="skeleton h-24 rounded-lg"></div>
                <div class="skeleton h-24 rounded-lg"></div>
              </div>
            </div>

            <!-- Section 4: 最近采集历史 -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
              <div class="flex items-center mb-6 border-b pb-4">
                <i class="fa fa-history text-xl text-primary mr-3"></i>
                <h3 class="text-xl font-bold text-gray-800">采集历史</h3>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-100">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">任务名称</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">开始时间</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">结束时间</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                  </thead>
                  <tbody id="collection-history-tbody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="5" class="text-center py-4 text-gray-500">正在加载历史记录...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          `;
          container.innerHTML = fullHTML;

        // Re-cache elements AFTER innerHTML is updated
        this.elements.companySelect = document.getElementById('company-select');
        this.elements.filterStatusText = document.getElementById('filter-status-text');

        // Re-bind the event listener for the newly created select element
        if (this.elements.companySelect) {
            // Ensure no duplicate listeners if renderOverview is called multiple times without full page reload
            this.elements.companySelect.removeEventListener('change', this.handleCompanySelectChangeBound); 
            this.handleCompanySelectChangeBound = this.handleCompanySelectChange.bind(this); // Bind and store reference
            this.elements.companySelect.addEventListener('change', this.handleCompanySelectChangeBound);
        }

        try {
          if (!this.pageData) {
              this.pageData = await App.callApi('CollectionStatsService', 'getCollectionPageData');
          }
          
          if (this.elements.companySelect && this.pageData && this.pageData.competitors) {
              this.elements.companySelect.innerHTML = '<option value="">所有企业</option>' + 
                                        this.pageData.competitors.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
              
              // Set the selected value and status text on initial load based on current state
              if (this.competitorName) { 
                  this.elements.companySelect.value = this.competitorName;
                  this.elements.filterStatusText.textContent = `当前显示 "${this.competitorName}" 的数据`;
              } else {
                  this.elements.companySelect.value = ''; // Default to "所有企业"
                  this.elements.filterStatusText.textContent = '显示所有企业的数据';
              }
          }

          // Call render function with current cached data and filter
          this.processAndRenderOverviewCards(this.pageData, this.competitorName); 
        } catch(e) {
          handleFailure(e);
        }
      },

      // New method to handle company select change, separated for clarity and binding
      handleCompanySelectChange: function(event) {
          const selectedCompany = event.target.value;
          this.competitorName = selectedCompany ? selectedCompany.trim().toLowerCase() : '';
          const statusTextEl = this.elements.filterStatusText; // Use cached element reference
          if (statusTextEl) {
             statusTextEl.textContent = selectedCompany ? `当前显示 "${selectedCompany}" 的数据` : '显示所有企业的数据';
          }
          this.processAndRenderOverviewCards(this.pageData, this.competitorName);
      },

         processAndRenderOverviewCards: function(pageData, competitorNameToFilter) {
            const currentCompetitorFilter = competitorNameToFilter ? competitorNameToFilter.trim().toLowerCase() : null;

            if (!this.pageData) {
                console.error("processAndRenderOverviewCards被调用，但this.pageData为空。");
                return;
            }
            
            // 获取所有需要更新的 DOM 元素
            const techGrid = document.getElementById('tech-data-grid');
            const benchmarkGrid = document.getElementById('benchmark-data-grid');
            const statsGrid = document.getElementById('collection-stats-grid');
            const historyTbody = document.getElementById('collection-history-tbody');

            // 定义统一的日期字段映射表
            const dateFieldMap = {
                academicPapers: 'publication_date',
                patentData: 'application_date',
                openSourceData: 'last_commit_date',
                techNews: 'publication_date',
                industryDynamics: 'event_date',
                techInnovation: 'last_update_timestamp',
                productRelease: 'last_update_timestamp',
                talentFlow: 'last_update_timestamp'
            };

            // 辅助函数：计算单个卡片的数据
            const calculateCardData = (type, title, data) => {
              const allData = data || []; // 直接使用传入的数据
              const totalCount = allData.length;
              const ingestionDateField = dateFieldMap[type];
              const sevenDaysAgo = new Date();
              sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
              const todayCount = allData.filter(item => {
                  if (!item || !ingestionDateField || !item[ingestionDateField]) return false;
                  const itemDate = new Date(item[ingestionDateField]);
                  return !isNaN(itemDate.getTime()) && itemDate >= sevenDaysAgo;
              }).length;
              let status = "正常";
              if (totalCount > 0 && todayCount === 0) status = "暂停";
              let lastUpdate = '--';
              if (totalCount > 0) {
                  const dates = allData.map(item => new Date(item[ingestionDateField])).filter(d => !isNaN(d.getTime()));
                  if (dates.length > 0) {
                      dates.sort((a, b) => b - a);
                      lastUpdate = dates[0].toISOString().slice(0, 10);
                  }
              }
              return { sourceType: type, title, totalCount, todayCount, status, lastUpdate };
            };

            // 辅助函数：渲染卡片网格
            const renderCards = (container, cardData) => {
                if (!container) return;
                const statusColors = { '正常': 'bg-blue-100 text-blue-800', '暂停': 'bg-gray-100 text-gray-800' };
                container.innerHTML = cardData.map(card => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 flex flex-col justify-between min-h-[200px] shadow-sm hover:shadow-lg transition-shadow clickable-kpi" data-type="${card.sourceType}">
                        <div>
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="font-semibold text-gray-800 text-base">${card.title}</h3>
                                <span class="text-xs font-medium px-2 py-0.5 rounded-md ${statusColors[card.status]}">${card.status}</span>
                            </div>
                            <div class="flex text-center my-2">
                                <div class="w-1/2 pr-4 clickable-detail" data-detail="today" style="cursor:pointer;"><p class="text-3xl font-semibold text-primary">${card.todayCount.toLocaleString()}</p><p class="text-xs text-gray-500 mt-1">近7日</p></div>
                                <div class="w-1/2 pl-4 border-l border-gray-200 clickable-detail" data-detail="all" style="cursor:pointer;"><p class="text-3xl font-semibold text-gray-800">${card.totalCount.toLocaleString()}</p><p class="text-xs text-gray-500 mt-1">合计</p></div>
                            </div>
                        </div>
                        <div class="text-center text-xs text-gray-400 mt-3">最后采集: ${card.lastUpdate}</div>
                    </div>
                `).join('');
            };
            
            // 辅助函数：渲染统计数据
            const renderStats = (container, statsData) => {
                if (!container || !statsData) return;
                const formatChange = (change) => change >= 0 ? `<i class="fa fa-arrow-up mr-1"></i> ${change}% 较上月` : `<i class="fa fa-arrow-down mr-1"></i> ${Math.abs(change)}% 较上月`;
                const changeColor = (change) => change >= 0 ? 'text-green-500' : 'text-red-500';
                const failedChangeColor = (change) => change <= 0 ? 'text-green-500' : 'text-red-500';
                const failedFormatChange = (change) => change <= 0 ? `<i class="fa fa-arrow-down mr-1"></i> ${Math.abs(change)} 较上月` : `<i class="fa fa-arrow-up mr-1"></i> ${change} 较上月`;
                container.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="text-sm text-gray-500 mb-1">本月采集量</div>
                        <div class="text-2xl font-bold">${(statsData.monthlyVolume || 0).toLocaleString()}</div>
                        <div class="text-sm ${changeColor(statsData.monthlyChange || 0)} flex items-center mt-1">${formatChange(statsData.monthlyChange || 0)}</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="text-sm text-gray-500 mb-1">成功率</div>
                        <div class="text-2xl font-bold">${statsData.successRate || 0}%</div>
                        <div class="text-sm ${changeColor(statsData.successRateChange || 0)} flex items-center mt-1">${formatChange(statsData.successRateChange || 0)}</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="text-sm text-gray-500 mb-1">失败任务</div>
                        <div class="text-2xl font-bold">${statsData.failedTasks || 0}</div>
                        <div class="text-sm ${failedChangeColor(statsData.failedTasksChange || 0)} flex items-center mt-1">${failedFormatChange(statsData.failedTasksChange || 0)}</div>
                    </div>
                `;
            };

            // 辅助函数：渲染历史记录
            const renderHistory = (container, historyData) => {
                if (!container) return;
                if (!Array.isArray(historyData) || historyData.length === 0) { 
                    container.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">暂无历史记录。</td></tr>`; 
                    return; 
                }
                const statusClasses = { 'completed': 'bg-green-100 text-green-800', 'failed': 'bg-red-100 text-red-800', 'running': 'bg-blue-100 text-blue-800', 'success': 'bg-green-100 text-green-800' };
                container.innerHTML = historyData.map(log => {
                    const actionCellHTML = log.execution_id ? `<button class="text-primary hover:text-primary-dark view-history-detail-btn" data-execution-id="${log.execution_id}">查看详情</button>` : `<span class="text-gray-400 cursor-not-allowed">无详情</span>`;
                    return `<tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap"><div class="font-medium text-gray-900">${log.workflow_name || 'N/A'}</div></td>
                                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${log.start_timestamp || 'N/A'}</div></td>
                                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${log.end_timestamp || 'N/A'}</div></td>
                                <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClasses[String(log.execution_status||'').toLowerCase()]||'bg-gray-100'}">${log.execution_status||'未知'}</span></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${actionCellHTML}</td>
                            </tr>`;
                }).join('');
            };

            // --- 数据处理与渲染执行 ---
            
            // ✅ 从传入的 pageData 中安全地获取数据
            const techData = pageData.techData || {};
            const benchmarkData = pageData.benchmarkData || {};
            const overallStats = pageData.overallStats || {};
            const history = pageData.history || [];
            
            const techCards = [
              // ✅ 将正确的数据子集传递给 calculateCardData
              calculateCardData('academicPapers', '学术论文', techData.academicPapers),
              calculateCardData('patentData', '技术专利', techData.patentData),
              calculateCardData('openSourceData', '开源项目', techData.openSourceData),
              calculateCardData('techNews', '技术新闻', techData.techNews)
            ];

            const competitorFilter = (item) => !currentCompetitorFilter || (item.competitor_name && String(item.competitor_name).toLowerCase().includes(currentCompetitorFilter));
            const allIndustryDynamics = benchmarkData.industryDynamics || [];
            const allCompetitorIntel = benchmarkData.competitorIntelligence || [];

            // ✅ 核心修正：筛选所有标杆数据，而不仅仅是 industryDynamics
            const filteredIndustryDynamics = (pageData.benchmarkData.industryDynamics || []).filter(item => isRelatedToCompany(item, currentCompetitorFilter));
            const filteredTechInnovation = (pageData.benchmarkData.competitorIntelligence || []).filter(item => isRelatedToCompany(item, currentCompetitorFilter) && item.intelligence_type === 'Tech Innovation');
            const filteredProductRelease = (pageData.benchmarkData.competitorIntelligence || []).filter(item => isRelatedToCompany(item, currentCompetitorFilter) && item.intelligence_type === 'Product Release');
            const filteredTalentFlow = (pageData.benchmarkData.competitorIntelligence || []).filter(item => isRelatedToCompany(item, currentCompetitorFilter) && item.intelligence_type === 'Talent Flow');
            
            const benchmarkCards = [
                calculateCardData('industryDynamics', '产业动态', filteredIndustryDynamics), // 使用过滤后的数据
                calculateCardData('techInnovation', '技术创新', filteredTechInnovation),     // 使用过滤后的数据
                calculateCardData('productRelease', '产品发布', filteredProductRelease),     // 使用过滤后的数据
                calculateCardData('talentFlow', '人才流动', filteredTalentFlow)             // 使用过滤后的数据
            ];

            renderCards(techGrid, techCards);
            renderCards(benchmarkGrid, benchmarkCards);
            renderStats(statsGrid, overallStats);
            renderHistory(historyTbody, history);
        },

        handleOverviewCardClick: function(event, pageData) {
          const card = event.target.closest('.clickable-kpi');
          if (!card) return;
          const type = card.dataset.type;
          const adapter = DataAdapters[type];
          if (!type || !adapter) return;

          const detailEl = event.target.closest('.clickable-detail');
          const detailKind = detailEl ? detailEl.dataset.detail : 'all';
          const title = card.querySelector('h3').innerText;
          
          App.currentDetailType = type;
          App.currentPage = 1;
          
          let rawData = [];
          const competitorFilter = (item) => !this.competitorName || (item.competitor_name && String(item.competitor_name).toLowerCase().includes(this.competitorName));

          const currentFilterCompany = this.competitorName; 

          // ✅ 直接从传入的 pageData 读取
          if (pageData.techData && pageData.techData[type]) {
            rawData = pageData.techData[type];
          } else if (this.pageData.benchmarkData) {
            const allIndustryDynamics = this.pageData.benchmarkData.industryDynamics || [];
            const allCompetitorIntel = this.pageData.benchmarkData.competitorIntelligence || [];
            
            switch (type) {
                case 'industryDynamics':
                    rawData = allIndustryDynamics.filter(item => isRelatedToCompany(item, currentFilterCompany));
                    // 这里有一个合并 generalnews 的逻辑，需要确保它也使用 isRelatedToCompany
                    const ciNews = (allCompetitorIntel || []).filter(item => isRelatedToCompany(item, currentFilterCompany) && (item.intelligence_type || '').toLowerCase().replace(/[\s_]/g, '') === 'generalnews')
                        .map(item => ({ event_title: item.intelligence_title, event_date: item.last_update_timestamp, impact_level: item.threat_level, processing_status: item.processing_status, source_url: item.source_url }));
                    rawData = [...rawData, ...ciNews]; // 合并 filteredIndustryDynamics 和 ciNews
                    break;
                case 'techInnovation':
                    rawData = allCompetitorIntel.filter(item => isRelatedToCompany(item, currentFilterCompany) && item.intelligence_type === 'Tech Innovation');
                    break;
                case 'productRelease':
                    rawData = allCompetitorIntel.filter(item => isRelatedToCompany(item, currentFilterCompany) && item.intelligence_type === 'Product Release');
                    break;
                case 'talentFlow':
                    rawData = allCompetitorIntel.filter(item => isRelatedToCompany(item, currentFilterCompany) && item.intelligence_type === 'Talent Flow');
                    break;
                default:
                    rawData = []; // 默认情况，如果没有匹配到类型，则为空
                    break;
            }
          } 

          let dataToAdapt = rawData;
          if (detailKind === 'today') {
              const dateFieldMap = {
                  academicPapers: 'publication_date',
                  patentData: 'application_date',
                  openSourceData: 'last_update_timestamp',
                  techNews: 'publication_date',
                  industryDynamics: 'event_date', // 修正为 'event_date'
                  techInnovation: 'last_update_timestamp',
                  productRelease: 'last_update_timestamp',
                  talentFlow: 'last_update_timestamp'
              };
              const dateField = dateFieldMap[type] || 'created_timestamp';
              const sevenDaysAgo = new Date();
              sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
              
              dataToAdapt = rawData.filter(item => {
                  const itemDate = new Date(item[dateField]);
                  return !isNaN(itemDate.getTime()) && itemDate >= sevenDaysAgo;
              });
          }
          
          App.allModalData = dataToAdapt.map(adapter);
          
          App.allModalData.sort((a, b) => {
              const dateA = new Date(a.date);
              const dateB = new Date(b.date);
              const timeA = isNaN(dateA.getTime()) ? 0 : dateA.getTime();
              const timeB = isNaN(dateB.getTime()) ? 0 : dateB.getTime(); 
              return timeB - timeA;
          });
          
          App.ui.showDetailListModal(title, detailKind);
        },
        
        // --- “工作流中心”标签页的逻辑 ---
        renderWorkflows: function() {
            const container = document.getElementById('tab-content-workflows');
            const workflowsByLayer = {
                1: [
                    { id: 'wf1', title: 'WF1: 学术论文监控', description: '从 arXiv 等来源监控与已注册技术相关的最新学术论文。', runFunction: 'runWf1_AcademicPapers' },
                    { id: 'wf2', title: 'WF2: 专利申请追踪', description: '从专利数据库追踪相关专利申请和授权情况。', runFunction: 'runWf2_PatentData' },
                    { id: 'wf3', title: 'WF3: 开源项目监测', description: '监测GitHub等平台上的新兴开源项目和技术趋势。', runFunction: 'runWf3_OpenSource' },
                    { id: 'wf4', title: 'WF4: 技术新闻获取', description: '从主流科技媒体获取与监控领域相关的产业新闻。', runFunction: 'runWf4_TechNews' },
                    { id: 'wf5', title: 'WF5: 产业动态捕获', description: '捕获行业会议、财报、法规等关键产业动态。', runFunction: 'runWf5_IndustryDynamics' },
                    { id: 'wf6', title: 'WF6: 业界标杆收集', description: '收集和整理来自多渠道的业界标杆公开线索。', runFunction: 'runWf6_Benchmark' }
                ],
                2: [
                    { id: 'wf7-1', title: 'WF7-1: 学术论文信号识别', description: '处理待定论文，识别高价值信号并创建线索记录。', runFunction: 'runWf7_1_AcademicSignalIdentification' },
                    { id: 'wf7-2', title: 'WF7-2: 专利数据信号识别', description: '评估专利的重要性、威胁等级，并生成线索。', runFunction: 'runWf7_2_PatentSignal' },
                    { id: 'wf7-3', title: 'WF7-3: 开源项目信号识别', description: '评估开源项目的潜力、趋势，并生成线索。', runFunction: 'runWf7_3_OpenSourceSignal' },
                    { id: 'wf7-4', title: 'WF7-4: 技术新闻信号识别', description: '评估技术新闻的价值、影响，并生成线索。', runFunction: 'runWf7_4TechNewsSignal' },
                    { id: 'wf7-5', title: 'WF7-5: 产业动态信号识别', description: '评估产业动态的战略影响，并生成线索。', runFunction: 'runWf7_5IndustryDynamics' },
                    { id: 'wf7-6', title: 'WF7-6: 竞争线索信号识别', description: '评估竞争线索的威胁等级，并生成线索。', runFunction: 'runWf7_6Benchmark' }
                ],
                3: [{ id: 'wf8', title: 'WF8: 统一证据验证', description: '对所有新生成的线索进行多源交叉验证和质量评分。', runFunction: 'runWf8_EvidenceValidation' }],
                4: [{ id: 'wf9', title: 'WF9: 商业价值分析', description: '对已验证线索进行TAM/SAM/SOM市场建模和ROI计算。', runFunction: 'runWf9_CommercialValueAnalysis' }, { id: 'wf10', 'title': 'WF10: 竞争线索分析', description: '评估竞争格局、技术威胁，并识别机会与挑战。', runFunction: 'runWf10_CompetitiveIntelAnalysis' }, { id: 'wf11', title: 'WF11: 技术深度分析', description: '评估技术成熟度(TRL)、技术壁垒和演进路径。', runFunction: 'runWf11_TechnicalDeepAnalysis' }],
                5: [{ id: 'wf12', title: 'WF12: 线索整合决策', description: '综合所有分析维度，计算综合评分并生成行动建议。', runFunction: 'runWf12_IntelligenceIntegration' }, { id: 'wf13', title: 'WF13: 报告生成输出', description: '自动生成日报、周报，并分发至邮件、仪表板等渠道。', runFunction: 'runWf13_ReportGeneration' }],
                6: [{ id: 'wf14', title: 'WF14: 数据质量监控', description: '定期检查整个系统的数据质量、完整性和一致性。', runFunction: 'runWf14_DataQualityMonitor' }, { id: 'wf15', title: 'WF15: 系统健康检查', description: '监控所有工作流的运行状态和系统性能指标。', runFunction: 'runWf15_SystemHealthCheck' }]
            };
            const layerTitles = ["精准数据采集 (并行)", "分表信号识别 (串行)", "统一证据验证 (统一处理)", "深度分析 (并行)", "决策支撑 (串行)", "监控与维护 (独立运行)"];
            
            let html = `
                <div id="workbench-nav" class="sticky top-[var(--header-height)] bg-white/80 backdrop-blur-sm z-30 py-3 mb-6 rounded-lg shadow-sm">
                  <div class="max-w-7xl mx-auto px-2">
                    <nav class="flex justify-around items-center space-x-2 text-sm md:text-base">
                      <a href="#wf-section-1" class="workbench-nav-link px-3 py-2 font-semibold text-gray-600 hover:bg-gray-200 hover:text-primary rounded-md transition-all">第一层: 采集</a>
                      <a href="#wf-section-2" class="workbench-nav-link px-3 py-2 font-semibold text-gray-600 hover:bg-gray-200 hover:text-primary rounded-md transition-all">第二层: 识别</a>
                      <a href="#wf-section-3" class="workbench-nav-link px-3 py-2 font-semibold text-gray-600 hover:bg-gray-200 hover:text-primary rounded-md transition-all">第三层: 验证</a>
                      <a href="#wf-section-4" class="workbench-nav-link px-3 py-2 font-semibold text-gray-600 hover:bg-gray-200 hover:text-primary rounded-md transition-all">第四层: 分析</a>
                      <a href="#wf-section-5" class="workbench-nav-link px-3 py-2 font-semibold text-gray-600 hover:bg-gray-200 hover:text-primary rounded-md transition-all">第五层: 决策</a>
                      <a href="#wf-section-6" class="workbench-nav-link px-3 py-2 font-semibold text-gray-600 hover:bg-gray-200 hover:text-primary rounded-md transition-all">第六层: 监控</a>
                    </nav>
                  </div>
                </div>
                ${Object.keys(workflowsByLayer).map(layerNum => `
                    <div id="wf-section-${layerNum}" class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">第${"一二三四五六"[layerNum-1]}层：${layerTitles[layerNum-1]}</h3>
                        <div id="wf-layer-${layerNum}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${(workflowsByLayer[layerNum].length > 0) ? workflowsByLayer[layerNum].map(wf => `
                                <div id="wf-card-${wf.id}" class="bg-gray-50 border border-gray-200 rounded-lg p-4 flex flex-col shadow-sm transition-all hover:shadow-md">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-bold text-lg text-gray-800">${wf.title}</h4>
                                        <span id="${wf.id}-status-badge" class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-200 text-gray-700">空闲</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4 flex-grow">${wf.description}</p>
                                    <div class="text-xs text-gray-500 space-y-1 mb-4">
                                        <p><strong>上次运行:</strong> <span id="${wf.id}-last-run">从未</span></p>
                                        <p><strong>上次结果:</strong> <span id="${wf.id}-last-result">N/A</span></p>
                                    </div>
                                    <div class="mt-auto">
                                        <button data-wfid="${wf.id}" data-wffunction="${wf.runFunction}" class="w-full bg-primary text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors shadow focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-gray-400">
                                            <i class="fa fa-play-circle mr-2"></i>立即执行
                                        </button>
                                    </div>
                                    <div id="${wf.id}-log-output" class="mt-4 p-2 bg-gray-800 text-white text-xs rounded-md h-24 overflow-y-auto font-mono hidden"></div>
                                </div>
                            `).join('') : '<div class="text-gray-400 p-4 col-span-full">此层级暂无工作流。</div>'}
                        </div>
                    </div>
                `).join('')}
            `;
            container.innerHTML = html;
        },

        handleWorkflowRunClick: async function(button) {
            if (!button || button.disabled) return;
            const wfId = button.dataset.wfid;
            const wfName = button.dataset.wffunction;
            if (!wfId || !wfName) return;

            const statusBadge = document.getElementById(`${wfId}-status-badge`);
            const lastRunSpan = document.getElementById(`${wfId}-last-run`);
            const lastResultSpan = document.getElementById(`${wfId}-last-result`);
            const logOutput = document.getElementById(`${wfId}-log-output`);

            button.disabled = true;
            button.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>执行中...';
            statusBadge.textContent = '运行中';
            logOutput.textContent = '任务已发送，请耐心等待后端返回结果...';
            lastResultSpan.textContent = 'N/A';
            logOutput.classList.remove('hidden');

            try {
                const result = await App.callApi('WorkflowsService', wfName);
                const isSuccess = result.success;
                statusBadge.textContent = isSuccess ? '成功' : '失败';
                statusBadge.className = `px-2 py-1 text-xs font-semibold rounded-full ${isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                lastRunSpan.textContent = new Date().toLocaleString();
                lastResultSpan.textContent = result.message || (isSuccess ? '执行完毕' : '未知错误');
                logOutput.textContent = result.log || '无详细日志。';
            } catch (e) {
                statusBadge.textContent = '失败';
                lastResultSpan.textContent = e.message;
                logOutput.textContent = e.stack;
                handleFailure(e);
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fa fa-play-circle mr-2"></i>再次执行';
            }
        },
        
        setupScrollObserver: function() {
          if (this.scrollObserver) this.scrollObserver.disconnect();
          const sections = document.querySelectorAll('#tab-content-workflows [id^="wf-section-"]');
          const navLinks = document.querySelectorAll('#tab-content-workflows .workbench-nav-link');
          if (sections.length === 0 || navLinks.length === 0) return;

          const observerOptions = { root: null, rootMargin: '-30% 0px -65% 0px', threshold: 0 };
          
          this.scrollObserver = new IntersectionObserver(entries => {
            let topMostIntersectingId = null;
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                if (topMostIntersectingId === null) {
                    topMostIntersectingId = entry.target.getAttribute('id');
                }
              }
            });
            
            if(topMostIntersectingId) {
                navLinks.forEach(link => {
                  const isActive = link.getAttribute('href') === `#${topMostIntersectingId}`;
                  link.classList.toggle('bg-primary', isActive);
                  link.classList.toggle('text-white', isActive);
                  link.classList.toggle('text-gray-600', !isActive);
                });
            }
          }, observerOptions);

          sections.forEach(section => {
              if(section) this.scrollObserver.observe(section);
          });
        }
      },
     // 请将此代码块完整替换您文件中 App.pageInitializers.insights 的部分

      // 请将此代码块完整替换您文件中 App.pageInitializers.insights 的部分

// ====================================================================================================
//  请将此代码块完整替换您文件中 App.pageInitializers.insights 的部分
// ====================================================================================================

// ====================================================================================================
//  请将此代码块完整替换您文件中 App.pageInitializers.insights 的部分
// ====================================================================================================

        // ✅ 最终、完整、无省略的 insights 初始化器
        insights: {
            isInitialized: false,
            activeTab: 'trends',
            charts: {},
            expertNetworkCategories: [],
            
            init: async function() {
                if (this.isInitialized) {
                    // 如果已经初始化，只需确保当前激活的tab内容被加载
                    await this.loadActiveTabContent();
                    return;
                }

                console.log('首次初始化智能分析页面...');
                this.bindEventListeners(); // 只绑定一次静态事件
                // ✅ 核心修复：在加载内容前，先调用函数更新标签的视觉样式
                this.updateTabStyles();
                // 初始加载默认标签页
                await this.loadActiveTabContent();
                this.isInitialized = true;
            },
        
            bindEventListeners: function() {
                window.addEventListener('resize', () => {
                    setTimeout(() => {
                        Object.values(this.charts).forEach(chart => {
                            if (chart && !chart.isDisposed()) chart.resize();
                        });
                    }, 200);
                });
        
                document.getElementById('insightsPrevPageBtn').addEventListener('click', () => {
                    if (App.insightsCurrentPage > 1) {
                        App.insightsCurrentPage--;
                        this.loadLatestInsightsTable();
                    }
                });
                document.getElementById('insightsNextPageBtn').addEventListener('click', () => {
                    if (App.insightsCurrentPage < App.insightsTotalPages) {
                        App.insightsCurrentPage++;
                        this.loadLatestInsightsTable();
                    }
                });
                document.getElementById('analyzation-tabs').addEventListener('click', this.handleTabClick.bind(this));
            },
        
            handleTabClick: function(event) {
                const link = event.target.closest('a.analyzation-tab');
                if (!link) return;
                event.preventDefault();
                const tabName = link.dataset.tab;
                if (tabName === this.activeTab) return;
                
                this.activeTab = tabName;
                this.updateTabStyles();
                this.loadActiveTabContent();
            },
        
            updateTabStyles: function() {
                document.querySelectorAll('.analyzation-tab').forEach(tab => {
                    tab.classList.toggle('border-primary', tab.dataset.tab === this.activeTab);
                    tab.classList.toggle('text-primary', tab.dataset.tab === this.activeTab);
                    tab.classList.toggle('border-transparent', tab.dataset.tab !== this.activeTab);
                    tab.classList.toggle('text-gray-500', tab.dataset.tab !== this.activeTab);
                });
                document.querySelectorAll('.analyzation-tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== `tab-content-${this.activeTab}`);
                });
            },
        
            getOrCreateChart: function(key, containerId) {
                if (!this.charts[key] || this.charts[key].isDisposed()) {
                    const container = document.getElementById(containerId);
                    if (container) {
                        this.charts[key] = echarts.init(container);
                        console.log(`ECharts 实例 "${key}" 已在可见容器上创建。`);
                    } else {
                        console.error(`图表容器 "${containerId}" 未找到！`);
                        return null;
                    }
                }
                return this.charts[key];
            },
        
            loadActiveTabContent: async function() {
                const tab = this.activeTab;
                console.log(`加载标签页: ${tab}`);
                
                try {
                    if (tab === 'trends') {
                        this.loadLatestInsightsTable();
                        const chartTrend = this.getOrCreateChart('trendChart', 'trend-chart-container');
                        const chartKeyword = this.getOrCreateChart('keywordChart', 'keyword-cloud-container');
                        if (App.cachedData.trendsAndKeywords) {
                            this.renderTrendsChart(App.cachedData.trendsAndKeywords.trendData);
                            this.renderKeywordsCloud(App.cachedData.trendsAndKeywords.keywordData);
                        } else {
                            chartTrend.showLoading({ text: '加载中...' });
                            chartKeyword.showLoading({ text: '加载中...' });
                            const data = await App.callApi('InsightsService', 'getInsightsPageData');
                            App.cachedData.trendsAndKeywords = data;
                            this.renderTrendsChart(data.trendData);
                            this.renderKeywordsCloud(data.keywordData);
                        }
                    } else if (tab === 'hype-cycle') {
                        const chart = this.getOrCreateChart('hypeCycleChart', 'hype-cycle-chart-container');
                        if (App.cachedData.hypeCycleData) {
                            this.renderHypeCycleChart(App.cachedData.hypeCycleData);
                        } else {
                            chart.showLoading({ text: '加载中...' });
                            const data = await App.callApi('InsightsService', 'getInsightsPageData');
                            App.cachedData.hypeCycleData = data.hypeCycleData;
                            this.renderHypeCycleChart(data.hypeCycleData);
                        }
                    } else if (tab === 'knowledge-graph') {
                        const chart = this.getOrCreateChart('knowledgeGraphChart', 'knowledge-graph-container');
                        if (App.cachedData.knowledgeGraphData) {
                            this.renderKnowledgeGraph(App.cachedData.knowledgeGraphData);
                        } else {
                            chart.showLoading({ text: '加载中...' });
                            const data = await App.callApi('InsightsService', 'getKnowledgeGraphData');
                            App.cachedData.knowledgeGraphData = data;
                            this.renderKnowledgeGraph(data);
                        }
                    } else if (tab === 'expert-network') {
                        const chart = this.getOrCreateChart('expertNetworkChart', 'expert-network-container');
                        if (App.cachedData.expertNetworkData) {
                            this.renderExpertNetwork(App.cachedData.expertNetworkData);
                            if (chart && !chart.isDisposed()) {
                              chart.off('click'); // 清理旧的点击事件监听器
                              chart.on('click', 'series.graph', (params) => {
                                  if (params.dataType === 'node') {
                                      console.log("DEBUG: ECharts node click event fired. params.data:", params.data); // 新增调试日志
                                      this.updateExpertNodeDetails(params.data);
                                  }
                              });
                              console.log("专家网络图谱的点击事件已成功绑定。");
                          }
                        } else {
                            chart.showLoading({ text: '加载中...' });
                            const data = await App.callApi('InsightsService', 'getExpertNetworkData');
                            App.cachedData.expertNetworkData = data;
                            this.renderExpertNetwork(data);

                            // ✅ 核心修复：在渲染完成后，为最新的图表实例绑定事件
                            if (chart && !chart.isDisposed()) {
                                chart.off('click'); // 先清理
                                chart.on('click', 'series.graph', (params) => {
                                    if (params.dataType === 'node') {
                                        this.updateExpertNodeDetails(params.data);
                                    }
                                });
                                console.log("专家网络图谱的点击事件已成功绑定。");
                            }
                        }
                    }
                } catch (error) {
                    handleFailure(error);
                }
            },
        
            renderTrendsChart: function(data) {
                const chart = this.getOrCreateChart('trendChart', 'trend-chart-container');
                if (!chart) return;
                chart.hideLoading();
                if (!data || !data.xAxis || data.xAxis.length === 0) {
                    chart.clear();
                    document.getElementById('trend-chart-container').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">暂无趋势分析数据</div>';
                    return;
                }
                const option = {
                    tooltip: { trigger: 'axis', axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } } },
                    grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                    xAxis: [{ type: 'category', boundaryGap: false, data: data.xAxis }],
                    yAxis: [{ type: 'value', min: 0, splitLine: { lineStyle: { type: 'dashed' } } }],
                    series: [{ name: '洞察数量', type: 'line', smooth: true, data: data.seriesData, symbol: 'circle', symbolSize: 8, lineStyle: { width: 3, color: '#007bff' }, itemStyle: { color: '#007bff' }, areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(0, 123, 255, 0.3)' }, { offset: 1, color: 'rgba(255, 255, 255, 0)' }]) }, emphasis: { focus: 'series' } }]
                };
                chart.setOption(option, true);
            },
        
            renderKeywordsCloud: function(data) {
                const chart = this.getOrCreateChart('keywordChart', 'keyword-cloud-container');
                if (!chart) return;
                chart.hideLoading();
                if (!data || data.length === 0) {
                    chart.clear();
                    document.getElementById('keyword-cloud-container').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">暂无热点关键词数据</div>';
                    return;
                }
                const option = {
                    tooltip: { show: true, formatter: params => `${params.name} : ${params.value}` },
                    series: [{ type: 'wordCloud', left: 'center', top: 'center', width: '100%', height: '100%', shape: 'pentagon', gridSize: 2, sizeRange: [14, 60], rotationRange: [-45, 45], rotationStep: 45, drawOutOfBound: false, textStyle: { color: () => `rgb(${[Math.round(Math.random() * 160), Math.round(Math.random() * 160), Math.round(Math.random() * 160)].join(',')})` }, emphasis: { focus: 'self', textStyle: { shadowBlur: 10, shadowColor: '#333' } }, data: data }]
                };
                chart.setOption(option, true);
            },
        
            // frontend/main.js.html

// ✅ 请用这个最终的、完整的函数替换您代码中现有的 renderHypeCycleChart 函数

// frontend/main.js.html

// ✅ 请用这个最终的、与您的图片效果一致的函数，完整替换现有的 renderHypeCycleChart 函数

// frontend/main.js.html

// ✅ 请用这个最终的、与您的图片效果一致的函数，完整替换现有的 renderHypeCycleChart 函数

// frontend/main.js.html

// ✅ 请用这个最终的、调整了字体大小的函数，完整替换现有的 renderHypeCycleChart 函数

// frontend/main.js.html

// ✅ 请用这个最终的、可以为大颗粒显示标签的函数，完整替换现有的 renderHypeCycleChart 函数

renderHypeCycleChart: function(data) {
    const chart = this.getOrCreateChart('hypeCycleChart', 'hype-cycle-chart-container');
    if (!chart) return;
    chart.hideLoading();

    if (!data || data.length === 0) {
        chart.clear();
        document.getElementById('hype-cycle-chart-container').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">暂无有效的技术成熟度数据。</div>';
        return;
    }

    const getGraphicElements = () => {
        const stageStyles = {
            fontSize: 14, 
            fontWeight: 'bold'
        };
        return [
            { type: 'text', left: '10%', top: '93%', style: { ...stageStyles, text: '创新萌发期', textAlign: 'center', fill: '#0056b3' } },
            { type: 'text', left: '30%', top: '8%', style: { ...stageStyles, text: '期望膨胀期', textAlign: 'center', fill: '#d9534f' } },
            { type: 'text', left: '50%', top: '93%', style: { ...stageStyles, text: '泡沫破裂谷底期', textAlign: 'center', fill: '#6c757d' } },
            { type: 'text', left: '70%', top: '45%', style: { ...stageStyles, text: '稳步爬升复苏期', textAlign: 'center', fill: '#28a745' } },
            { type: 'text', left: '90%', top: '65%', style: { ...stageStyles, text: '生产力成熟期', textAlign: 'center', fill: '#ffc107' } }
        ];
    };

    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            formatter: p => p.seriesType === 'scatter' ? `<b>${p.data[4]}</b><br/>商业价值: ${p.data[2]}<br/>预计成熟时间: ${p.data[3]}` : ''
        },
        xAxis: {
            type: 'value', min: 0, max: 5.5, show: true,
            axisLabel: { show: false }, 
            axisTick: { show: false }, 
            axisLine: { lineStyle: { color: '#ccc' } },
            splitLine: { show: true, lineStyle: { color: '#eee', type: 'dashed' } }
        },
        yAxis: {
            type: 'value', min: 0, max: 100, show: true,
            axisLabel: { show: false }, 
            axisTick: { show: false }, 
            axisLine: { lineStyle: { color: '#ccc' } },
            splitLine: { show: true, lineStyle: { color: '#eee', type: 'dashed' } }
        },
        grid: {
            left: '2%', right: '2%', top: '15%', bottom: '15%'
        },
        graphic: getGraphicElements(),
        series: [
            {
                type: 'line',
                data: [[0.5, 30], [2.0, 95], [3.0, 25], [4.0, 60], [5.0, 50]],
                smooth: 0.6,
                symbol: 'none',
                lineStyle: {
                    color: '#28a745',
                    width: 2,
                    type: 'solid'
                }
            },
            {
                type: 'scatter',
                data: data,
                symbolSize: d => Math.sqrt(d[2] || 1) * 8 + 6,
                itemStyle: {
                    color: '#0056b3',
                    opacity: 0.9
                },
                emphasis: {
                    focus: 'self',
                    scale: 1.25
                },
                // --- 核心修改点：动态显示标签 ---
                label: {
                    // 使用函数来决定是否显示标签
                    show: function (params) {
                        // params.data 是一个数组，例如：[x, y, commercialValue, maturity, name]
                        // 我们根据商业价值分（索引为2）来判断
                        const commercialValue = params.data[2] || 0;
                        // 只为商业价值评分大于等于7的技术显示标签
                        return commercialValue >= 7;
                    },
                    position: 'top',
                    formatter: p => p.data[4], // 标签内容为技术名称
                    fontSize: 11,
                    color: '#333',
                    distance: 5, // 标签与数据点的距离
                    backgroundColor: 'rgba(255, 255, 255, 0.7)', // 为标签添加半透明背景，防止与曲线重叠
                    padding: [3, 5],
                    borderRadius: 3
                }
                // --- 核心修改点结束 ---
            }
        ]
    };
    chart.setOption(option, true);
    // 确保窗口大小调整时，文本能重新计算位置
    chart.on('resize', () => chart.setOption({ graphic: getGraphicElements() }));
},



        
            renderKnowledgeGraph: function(data) {
  const chart = this.getOrCreateChart('knowledgeGraphChart', 'knowledge-graph-container');
  if (!chart) return;
  chart.hideLoading();
  if (!data || !data.nodes || data.nodes.length === 0) {
      chart.clear();
      document.getElementById('knowledge-graph-container').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">暂无技术知识图谱数据</div>';
      return;
  }
  const edges = data.edges || [];
  let linksWithStyle = [];
  if (edges.length > 0) {
      const values = edges.map(edge => edge.value || 1);
      const maxEdgeValue = Math.max(...values);
      const logBase = 2;
      const maxLogValue = Math.log(maxEdgeValue) / Math.log(logBase);
      linksWithStyle = edges.map(edge => {
          const weight = edge.value || 1;
          const logValue = Math.log(weight) / Math.log(logBase);
          const ratio = maxLogValue > 0 ? logValue / maxLogValue : 0;
          return { ...edge, lineStyle: { width: 0.5 + ratio * 10, opacity: 0.4 + ratio * 0.5, curveness: 0.2 } };
      });
  }

  // --- 核心修改在这里 ---
  const option = {
      tooltip: { 
        formatter: function(params) { 
          if (params.dataType === 'node') { return `<b>${params.name}</b><br/>类型: ${params.data.category}<br/>提及次数: ${params.data.value}`; } 
          if (params.dataType === 'edge') { 
            const sourceName = params.data.sourceName || params.data.source; 
            const targetName = params.data.targetName || params.data.target; 
            return `<b>${sourceName}</b> - <b>${targetName}</b><br/>关系强度: ${params.data.value}`; 
          } 
          return ''; 
        } 
      },
      legend: [{ 
        data: ['技术领域', '竞争对手', '关键词'], 
        selectedMode: 'multiple', 
        bottom: 10, 
        itemGap: 20, 
        textStyle: { color: '#333' } 
      }],
      series: [{
          name: '技术知识图谱', type: 'graph', layout: 'force',
          data: data.nodes.map(node => {
              const symbolSize = Math.log2(node.value + 1) * 10 + 15;
              const isLabelInside = symbolSize > 40;
              return { 
                ...node, 
                symbolSize: symbolSize, 
                label: { 
                  show: true, 
                  position: isLabelInside ? 'inside' : 'right', 
                  formatter: '{b}', 
                  color: '#000000', 
                  fontWeight: 'normal', 
                  textBorderColor: isLabelInside ? '#FFFFFF' : 'transparent', 
                  textBorderWidth: isLabelInside ? 2 : 0, 
                  fontSize: 12 
                } 
              };
          }),
          links: linksWithStyle.map(link => { 
            const sourceNode = data.nodes.find(n => n.id === link.source); 
            const targetNode = data.nodes.find(n => n.id === link.target); 
            return { ...link, sourceName: sourceNode ? sourceNode.name : link.source, targetName: targetNode ? targetNode.name : link.target }; 
          }),
          
          // --- 优化后的 categories 配置 ---
          categories: [ 
            { 
              name: '技术领域',
              itemStyle: {
                color: '#5470C6', // 专业蓝紫色
                shadowBlur: 5, shadowColor: 'rgba(0, 0, 0, 0.3)'
              }
            }, 
            { 
              name: '竞争对手',
              itemStyle: {
                color: '#EE6666', // 醒目红色
                shadowBlur: 5, shadowColor: 'rgba(0, 0, 0, 0.3)'
              }
            }, 
            { 
              name: '关键词',
              itemStyle: {
                color: '#FFD700', // 明亮金色
                shadowBlur: 5, shadowColor: 'rgba(0, 0, 0, 0.3)'
              }
            } 
          ],
          // --- 优化配置结束 ---

          roam: true, draggable: true,
          force: { repulsion: 300, edgeLength: [100, 250], gravity: 0.08, },
          emphasis: { focus: 'adjacency', lineStyle: { opacity: 1, width: w => w + 2 }, label: { fontWeight: 'bold', fontSize: 14 } }
      }]
  };
  // --- 核心修改结束 ---

  chart.setOption(option, true);
},
        
             // ✅ 最终美化版：专家网络图谱渲染函数 (v3 - 视觉效果增强)
// ✅ 最终美化版：专家网络图谱渲染函数 (v11 - 修复交互健壮性)
renderExpertNetwork: function(data) {
    const chart = this.getOrCreateChart('expertNetworkChart', 'expert-network-container');
    if (!chart) return;
    chart.hideLoading();

    if (!data || !data.nodes || data.nodes.length === 0) {
        chart.clear();
        document.getElementById('expert-network-container').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">暂无专家网络数据。</div>';
        return;
    }

    // --- 动态颜色和类别生成 (保持不变) ---
    const colorPalette = ['#FFC300', '#FF5733', '#C70039', '#900C3F', '#581845', '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd'];
    let colorIndex = 0;
    this.expertNetworkCategories = [{ name: '机构', itemStyle: { color: '#6c757d' } }];
    const techAreaCategoryMap = new Map([['机构', 0]]);
    data.nodes.forEach(node => {
        if (node.category === '专家' && node.main_tech_areas && node.main_tech_areas.length > 0) {
            const primaryArea = node.main_tech_areas[0];
            if (!techAreaCategoryMap.has(primaryArea)) {
                const categoryIndex = this.expertNetworkCategories.length;
                techAreaCategoryMap.set(primaryArea, categoryIndex);
                this.expertNetworkCategories.push({ name: primaryArea, itemStyle: { color: colorPalette[colorIndex++ % colorPalette.length] } });
            }
        }
    });

    // --- 节点和边的处理 (保持不变) ---
    const MAX_NODE_VALUE = Math.max(1, ...data.nodes.map(n => n.value || 0));
    const nodes = data.nodes.map(node => {
        const value = node.value || 0;
        const primaryArea = node.main_tech_areas && node.main_tech_areas.length > 0 ? node.main_tech_areas[0] : '机构';
        return {
            ...node,
            symbolSize: 12 + (value / MAX_NODE_VALUE) * 38,
            category: techAreaCategoryMap.get(primaryArea) || 0,
        };
    });
    const maxEdgeValue = Math.max(1, ...data.edges.map(e => e.value || 1));
    const links = data.edges.map(edge => ({
        ...edge,
        lineStyle: { width: 0.5 + Math.sqrt(edge.value || 1) }
    }));
    
    // ✅ 修复：将 this.expertNetworkCategories 赋值给一个局部变量，以解决作用域问题
    const categoriesForOption = this.expertNetworkCategories;

    const option = {
        backgroundColor: '#FFFFFF',
        tooltip: {
            formatter: (params) => { // 使用箭头函数保持 this 指向（虽然这里没用this，但好习惯）
                if (params.dataType === 'edge') return `合作强度: ${params.value}`;
                if (params.dataType === 'node') {
                    const nodeData = params.data;
                    // ✅ 使用从外部传入的 categoriesForOption，不再报错
                    const categoryName = categoriesForOption[nodeData.category].name;
                    let details = `<div style="font-weight:bold; margin-bottom: 5px;">${nodeData.name}</div>`;
                    details += `<div>类型: ${categoryName}</div>`;
                    if (categoryName !== '机构') {
                        details += `<div>论文数: ${nodeData.paper_count || 0}</div>`;
                        details += `<div>专利数: ${nodeData.patent_count || 0}</div>`;
                    } else {
                        details += `<div>关联专家数: ${nodeData.value || 0}</div>`;
                    }
                    return details;
                }
                return '';
            }
        },
        legend: [{ data: categoriesForOption.map(c => c.name), bottom: 10 }],
        series: [{
            name: '专家网络图谱',
            type: 'graph',
            layout: 'force',
            data: nodes,
            links: links,
            categories: categoriesForOption, // ✅ 使用局部变量
            roam: true,
            label: { show: true, position: 'right', color: '#000', fontWeight: 'normal', hideOverlap: true },
            force: { repulsion: 120, edgeLength: 120, gravity: 0.03 },
            lineStyle: { color: 'source', curveness: 0.2, opacity: 0.5 },
            emphasis: { focus: 'adjacency', label: { fontSize: 14, fontWeight: 'bold' }, lineStyle: { width: 6, opacity: 1 } }
        }]
    };
    chart.setOption(option, true);

    // --- 绑定事件 (保持不变，但现在可以正常工作了) ---
    // chart.off('click');
    // chart.on('click', 'series.graph', (params) => {
    //     if (params.dataType === 'node') {
    //         this.updateExpertNodeDetails(params.data);
    //     }
    // });
    
    // const zr = chart.getZr();
    // zr.off('click');
    // zr.on('click', (event) => {
    //     if (!event.target) {
    //         this.updateExpertNodeDetails(null);
    //     }
    // });
},

    updateExpertNodeDetails: async function(nodeData) {
    const detailsContainer = document.getElementById('expert-node-details');
    if (!detailsContainer) {
        console.error("ERROR: 节点详情容器 'expert-node-details' 未找到。");
        return;
    }

    // ========== 添加调试日志 ==========
    console.log("DEBUG: updateExpertNodeDetails 被调用。");
    console.log("DEBUG: 接收到的 nodeData:", nodeData);
    if (nodeData) {
        console.log("DEBUG: nodeData.id:", nodeData.id);
        console.log("DEBUG: typeof nodeData.id:", typeof nodeData.id);
    }
    // ==================================

    if (!nodeData || nodeData.id === undefined || nodeData.id === null || nodeData.id === '') { // 更加严格的检查
        console.log("DEBUG: nodeData 无效或 nodeData.id 缺失，显示默认提示。");
        detailsContainer.innerHTML = '<p class="text-gray-500">点击图谱中的节点查看详情。</p>';
        return;
    }
    
    // 确保 category 是一个数字索引，并且在 expertNetworkCategories 数组范围内
    const categoryIndex = typeof nodeData.category === 'number' ? nodeData.category : 0; // 默认为0，即“机构”
    const categoryName = (this.expertNetworkCategories && this.expertNetworkCategories[categoryIndex])
        ? this.expertNetworkCategories[categoryIndex].name
        : '未知类别';

    console.log("DEBUG: 解析出的 categoryName:", categoryName);
    console.log("DEBUG: nodeData.paper_count:", nodeData.paper_count);
    console.log("DEBUG: nodeData.patent_count:", nodeData.patent_count);
    console.log("DEBUG: nodeData.main_tech_areas:", nodeData.main_tech_areas);

    let detailsHtml = '';
    // 修正：使用 nodeData.paper_count 或 nodeData.patent_count 是否存在来判断是否为专家节点
    // 这样即使 categoryName 被 ECharts 动态修改，也能正确识别
    if (nodeData.paper_count !== undefined || nodeData.patent_count !== undefined) { // 假设专家节点有这两个属性
        detailsHtml = `
                <div class="font-bold text-lg mb-3 pb-2 border-b">${nodeData.name || '未知专家'}</div>
                <div class="space-y-2 text-sm">
                    <p><strong>类型:</strong> <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">${categoryName}</span></p>
                    <p><strong>论文数:</strong> <span class="font-semibold text-primary text-base">${nodeData.paper_count || 0}</span></p>
                    <p><strong>专利数:</strong> <span class="font-semibold text-primary text-base">${nodeData.patent_count || 0}</span></p>
                    <!-- ✅ 新增：显示所属机构 -->
                    <p><strong>所属机构:</strong> <span class="font-semibold text-primary text-base">${nodeData.affiliation_name || '未知机构'}</span></p>
                    <p><strong>主要技术领域:</strong> <span class="font-semibold text-primary text-base">${(nodeData.main_tech_areas && nodeData.main_tech_areas.length > 0) ? nodeData.main_tech_areas.join(', ') : '暂无'}</span></p>
                </div>
                <h4 class="font-bold text-md mt-4 mb-2">专家简介</h4>
                <div id="ai-expert-summary-content" class="text-sm text-gray-700">AI生成中，请稍候...</div>
            `;
            detailsContainer.innerHTML = detailsHtml; // 先渲染基础信息和加载提示

            // 调用后端AI生成简介
            try {
                const aiSummary = await App.callApi(
                    'InsightsService',
                    'generateExpertSummary',
                    [
                        nodeData.name,
                        categoryName, // 传入解析后的类别名称作为主要技术领域
                        nodeData.affiliation_name || '未知机构', // ✅ 新增：传递机构名称
                        nodeData.paper_count || 0,
                        nodeData.patent_count || 0,
                        nodeData.main_tech_areas || []
                    ]
                );

                // ✅ 简化判断逻辑：直接检查返回内容是否以“AI简介生成失败”开头
                if (aiSummary && !String(aiSummary).startsWith("AI简介生成失败")) { // 确保aiSummary是字符串
                    document.getElementById('ai-expert-summary-content').innerText = aiSummary; // 填充AI简介
                } else {
                    // 如果aiSummary为空，或者以“AI简介生成失败”开头，则显示错误信息
                    document.getElementById('ai-expert-summary-content').innerText = aiSummary || "AI简介生成失败：无返回内容。";
                }
            } catch (e) {
                console.error("AI专家简介生成失败:", e);
                document.getElementById('ai-expert-summary-content').innerText = `AI简介生成失败: ${e.message}`; // 显示错误信息
            }
    } else if (categoryName === '机构') { // 机构节点
        detailsHtml = `
            <div class="font-bold text-lg mb-3 pb-2 border-b">${nodeData.name || '未知机构'}</div>
            <div class="space-y-2 text-sm">
                <p><strong>类型:</strong> <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-800">机构</span></p>
                <p><strong>关联专家数:</strong> <span class="font-semibold text-primary text-base">${nodeData.value || 0}</span></p>
            </div>
        `;
    } else { // 其他未知类型或通用类型
        detailsHtml = `
            <div class="font-bold text-lg mb-3 pb-2 border-b">${nodeData.name || '未知名称'}</div>
            <div class="space-y-2 text-sm">
                <p><strong>类型:</strong> <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">${categoryName}</span></p>
            </div>
        `;
    }
    //detailsContainer.innerHTML = detailsHtml;
},
        
            loadLatestInsightsTable: async function() {
                const tableBody = document.querySelector('#page-insights table tbody');
                const paginationInfoSpan = document.getElementById('insightsPaginationInfo');
                const prevPageBtn = document.getElementById('insightsPrevPageBtn');
                const nextPageBtn = document.getElementById('insightsNextPageBtn');
                if (!tableBody || !paginationInfoSpan || !prevPageBtn || !nextPageBtn) { console.error("洞察线索表格或分页控件未找到。"); return; }
                
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8">正在加载最新线索...</td></tr>`;
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
        
                try {
                    const { records, totalRecords } = await App.callApi('InsightsService', 'getLatestInsightsPaged', [App.insightsCurrentPage, App.insightsItemsPerPage]);
                    App.insightsTotalRecords = totalRecords;
                    App.insightsTotalPages = Math.ceil(totalRecords / App.insightsItemsPerPage) || 1;
        
                    if (!records || records.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-500">暂无最新洞察线索。</td></tr>`;
                    } else {
                        const statusMap = { 'decision_completed': { text: '已完成', classes: 'bg-green-100 text-green-800' }, 'analyzing': { text: '分析中', classes: 'bg-blue-100 text-blue-800' }, 'signal_identified': { text: '待处理', classes: 'bg-yellow-100 text-yellow-800' }, 'published': { text: '已发布', classes: 'bg-purple-100 text-purple-800' }, 'default': { text: '未知', classes: 'bg-gray-100 text-gray-800' } };
                        tableBody.innerHTML = records.map(item => {
                            const statusKey = (item.status || 'default').toLowerCase();
                            const statusInfo = statusMap[statusKey] || statusMap['default'];
                            const statusText = statusInfo.text === '未知' ? item.status : statusInfo.text;
                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4"><div class="font-medium text-gray-900" title="${item.title || ''}">${truncate(item.title, 60)}</div></td>
                                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${item.source || 'N/A'}</div></td>
                                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${item.date || 'N/A'}</div></td>
                                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo.classes}">${statusText}</span></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm"><button class="text-primary hover:text-primary-dark" data-insight-id="${item.id}">查看详情</button></td>
                                </tr>`;
                        }).join('');
                        
                        tableBody.querySelectorAll('button[data-insight-id]').forEach(button => {
                            button.onclick = async (e) => {
                                const insightId = e.target.dataset.insightId;
                                App.ui.showDetailListModal(`洞察详情: 正在加载...`, 'all');
                                document.getElementById('detailTable').innerHTML = '<tbody><tr><td colspan="2" class="text-center p-4">正在加载详情...</td></tr></tbody>';
                                try {
                                    const insightDetail = await App.callApi('InsightsService', 'getInsightDetail', [insightId]);
                                    if (insightDetail && !insightDetail.error) {
                                        App.currentDetailType = 'historyDetail';
                                        App.allModalData = Object.entries(insightDetail).map(([key, value]) => ({ key: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), value: value }));
                                        App.ui.showDetailListModal(`洞察详情: ${truncate(insightDetail.title, 30)}`, 'all');
                                    } else {
                                        alert(`未找到该洞察的详细信息: ${insightDetail.error || '未知错误'}`);
                                        App.ui.hideDetailModal();
                                    }
                                } catch (error) {
                                    alert(`获取洞察详情时发生错误: ${error.message}`);
                                    App.ui.hideDetailModal();
                                }
                            };
                        });
                    }
                    paginationInfoSpan.textContent = `第 ${App.insightsCurrentPage} / ${App.insightsTotalPages} 页 (共 ${App.insightsTotalRecords} 条)`;
                    prevPageBtn.disabled = App.insightsCurrentPage === 1;
                    nextPageBtn.disabled = App.insightsCurrentPage >= App.insightsTotalPages;
                } catch (e) {
                    handleFailure(e);
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-red-500">加载失败: ${e.message}</td></tr>`;
                }
            }
        },

      actions: {
        isInitialized: false,
        
        init: async function() {
          console.log('正在初始化深度研究中心页面...');
          if (!this.isInitialized) {
            document.getElementById('perform-research-btn').addEventListener('click', this.handlePerformResearch.bind(this));
            // ✅ 移除 markdownit 的初始化代码
            // if (typeof markdownit !== 'undefined') { this.md = new markdownit(); } else { console.error("ERROR: markdownit 库未加载！"); }
            this.isInitialized = true;
          }
          document.getElementById('research-results-display').innerHTML = '<p class="text-gray-500">在此输入查询并点击“开始深度研究”，AI将为您生成专业的研究报告。</p>';
        },

        handlePerformResearch: async function() {
            const queryInput = document.getElementById('research-query');
            const resultsDisplay = document.getElementById('research-results-display');
            const researchButton = document.getElementById('perform-research-btn');
            const loadingSpinner = document.getElementById('research-loading-spinner');

            const query = queryInput.value.trim();

            if (!query) {
                alert('请输入您的研究查询！');
                return;
            }

            researchButton.disabled = true;
            researchButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>研究中...';
            loadingSpinner.classList.remove('hidden');
            resultsDisplay.innerHTML = ''; // 清空旧结果

            try {
                // ✅ 后端现在直接返回 HTML
                const aiReportHtml = await App.callApi('DeepResearchService', 'performDeepResearch', [query]);

                if (aiReportHtml && !String(aiReportHtml).startsWith("AI深度研究失败")) {
                    // ✅ 直接将后端返回的 HTML 插入到 DOM 中
                    resultsDisplay.innerHTML = aiReportHtml;
                } else {
                    resultsDisplay.innerHTML = `<p class="text-red-500">${aiReportHtml || "AI深度研究失败：无返回内容。"}</p>`;
                }
            } catch (e) {
                console.error("AI深度研究请求失败:", e);
                resultsDisplay.innerHTML = `<p class="text-red-500">AI深度研究请求失败: ${e.message}</p>`;
            } finally {
                researchButton.disabled = false;
                researchButton.innerHTML = '<i class="fa fa-flask mr-2"></i>开始深度研究';
                loadingSpinner.classList.add('hidden');
            }
        },
        
        // ✅ 增强版的 convertMarkdownToHtml 函数
        convertMarkdownToHtml: function(markdownText) {
            // Apps Script 的 HtmlService 会清理 HTML，所以我们不能直接用 innerHTML 插入复杂的 HTML 标签。
            // 最佳实践是让后端 AI 严格输出 Markdown，然后前端用一个非常安全的 Markdown 渲染器。
            // 由于 Apps Script 环境的特殊性，我们采用回退方案：
            // 1. 先安全地处理 HTML 实体，特别是 AI 可能输出的 HTML 标签
            // 2. 接着处理 Markdown 语法
            
            // 确保处理AI可能输出的HTML标签，HtmlService 会将其转义，所以我们需要先解码
            let html = markdownText
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&');

            // 1. 将所有 \n\n 替换为特殊的段落标记，\n 替换为换行标记
            html = html.replace(/\\n\\n/g, '@@PARAGRAPH@@'); // Markdown段落
            html = html.replace(/\\n/g, '@@LINEBREAK@@'); // Markdown换行

            // 2. 处理标题 (###, ##, #)
            // 匹配行首 ## 标题，并确保后面跟着内容和段落标记
            // 注意：Markdown H1 (#) 和 H2 (##) 需要被识别
            html = html.replace(/^###\s*(.*?)(@@PARAGRAPH@@|$)/gm, '<h3>$1</h3>@@PARAGRAPH@@');
            html = html.replace(/^##\s*(.*?)(@@PARAGRAPH@@|$)/gm, '<h2>$1</h2>@@PARAGRAPH@@');
            html = html.replace(/^#\s*(.*?)(@@PARAGRAPH@@|$)/gm, '<h1>$1</h1>@@PARAGRAPH@@');

            // 3. 处理列表 (-)
            // 匹配以 - 开头，后面跟着内容的行，直到遇到段落标记或下一个列表项
            html = html.replace(/^- (.*?)(@@LINEBREAK@@|$)/gm, '<li>$1</li>@@LINEBREAK@@'); // 使用 /gm 确保多行匹配
            // 将连续的 <li> 标签包裹在 <ul> 中
            // 这是一个简化的处理，对于复杂的嵌套列表可能不够
            html = html.replace(/((?:<li>.*?<\/li>@@LINEBREAK@@)*<li>.*?<\/li>)/gs, '<ul>$1</ul>');
            // 清理列表内部多余的 @@LINEBREAK@@
            html = html.replace(/<li>(.*?)@@LINEBREAK@@<\/li>/g, '<li>$1</li>');
            // 确保列表的开始和结束
            html = html.replace(/<ul>@@LINEBREAK@@/g, '<ul>');
            html = html.replace(/@@LINEBREAK@@<\/ul>/g, '</ul>');


            // 4. 处理粗体 (**) 和斜体 (*)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); // 斜体

            // 5. 处理链接 ([text](url))
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // 6. 替换段落标记和换行标记
            html = html.replace(/@@PARAGRAPH@@/g, '</p><p>'); // 段落
            html = html.replace(/@@LINEBREAK@@/g, '<br>'); // 换行

            // 7. 包裹在段落标签中（如果内容不是以标题或列表开头）
            // 确保整个内容被包裹在 <p> 标签中，处理开头和结尾
            // 移除开头的三个点和多余的空白符
            html = html.trim().replace(/^\.{3}/, ''); // 移除开头的三个点

            // 确保整个输出被一个父 <p> 标签包裹，除非它以 h1/h2/h3/ul/ol 开头
            const startsWithBlockTag = html.startsWith('<h1>') || html.startsWith('<h2>') || html.startsWith('<h3>') || html.startsWith('<ul>') || html.startsWith('<ol>');
            if (!startsWithBlockTag) {
                html = '<p>' + html;
            }
            // 确保所有段落正确闭合
            html = html.replace(/<\/p><p>/g, '</p>\n<p>'); // 格式化，增加可读性

            return html;
        }
      },
      reports: {
        isInitialized: false,
        init: async function() {
          console.log('Initializing Reports Page...');
          if (!this.isInitialized) {
            // 绑定事件监听器
            document.getElementById('generateReportBtn').addEventListener('click', App.pageInitializers.reports.handleGenerateReport);
            document.querySelectorAll('input[name="report-period"]').forEach(radio => {
              radio.addEventListener('change', App.pageInitializers.reports.handlePeriodChange); // ✅ 周期变化事件
            });
            document.getElementById('startDate').addEventListener('change', App.pageInitializers.reports.handlePeriodChange); // ✅ 自定义日期变化事件
            document.getElementById('endDate').addEventListener('change', App.pageInitializers.reports.handlePeriodChange); // ✅ 自定义日期变化事件
            document.getElementById('all-tech-areas').addEventListener('change', App.pageInitializers.reports.toggleAllTechAreas); // ✅ 全选事件

            await this.loadScheduledReportsStatus();
            
            // **新增：分页按钮事件监听器**
            document.getElementById('reportsHistoryPrevPageBtn').addEventListener('click', App.pageInitializers.reports.prevReportsHistoryPage);
            document.getElementById('reportsHistoryNextPageBtn').addEventListener('click', App.pageInitializers.reports.nextReportsHistoryPage);

            // ✅ 首次加载时，获取所有活跃技术领域并渲染复选框
            this.allAvailableTechAreas = await App.callApi('ReportsService', 'getAllActiveTechNames');
            this.renderTechAreaCheckboxes(this.allAvailableTechAreas);

            this.isInitialized = true;
          }
          // ✅ 初始化时，根据当前周期更新技术领域复选框状态
          // 每次进入页面都刷新历史记录，并重置页码为1
          App.reportsHistoryCurrentPage = 1; // 重置页码
          this.updateTechAreasBasedOnPeriod(); // 更新技术领域复选框状态
          await this.loadReportsHistory(); // 每次进入页面都刷新历史记录
        },

        // ✅ 辅助函数：渲染技术领域复选框
        renderTechAreaCheckboxes: function(techNames, enabledTechNames = null) {
          const container = document.getElementById('techAreaCheckboxesContainer'); // ✅ 新增的容器ID
          if (!container) {
            console.error("ERROR: Could not find techAreaCheckboxesContainer.");
            return;
          }
          let html = '';
          const allTechCheckboxChecked = document.getElementById('all-tech-areas').checked;

          techNames.forEach(techName => {
            const isEnabled = enabledTechNames === null || enabledTechNames.includes(techName);
            const isDisabled = enabledTechNames !== null && !isEnabled; // 如果提供了enabledTechNames，并且当前techName不在其中，则禁用
            const isChecked = allTechCheckboxChecked || isEnabled; // 如果全选，则所有都选中；否则根据是否enabled决定
            
            html += `
              <div class="flex items-center">
                <input type="checkbox" id="${techName.replace(/\s+/g, '_').toLowerCase()}" name="tech-area-checkbox" value="${techName}" class="h-4 w-4 text-primary focus:ring-primary border-gray-300" 
                  ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                <label for="${techName.replace(/\s+/g, '_').toLowerCase()}" class="ml-2 block text-sm text-gray-700 ${isDisabled ? 'text-gray-400' : ''}">${techName}</label>
              </div>
            `;
          });
          container.innerHTML = html;

          // 重新绑定单个技术领域复选框的事件监听器
          document.querySelectorAll('input[name="tech-area-checkbox"]:not(#all-tech-areas)').forEach(cb => {
            cb.addEventListener('change', App.pageInitializers.reports.handleSingleTechAreaChange);
          });
        },

        /**
         * **新增：加载并渲染自动化报告任务状态**
         */
        loadScheduledReportsStatus: async function() {
          const container = document.getElementById('scheduledReportsStatus');
          if (!container) return;

          container.innerHTML = `
            <h3 class="text-xl font-semibold mb-4 flex items-center">
              <i class="fa fa-clock-o text-primary mr-2"></i>自动化报告任务状态
            </h3>
            <div class="p-4 text-gray-500">正在加载自动化任务状态...</div>
          `; // 显示加载状态

          try {
            const statusData = await App.callApi('ReportsService', 'getScheduledReportsStatus');
            
            if (!statusData || statusData.length === 0) {
              container.innerHTML = `
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                  <i class="fa fa-clock-o text-primary mr-2"></i>自动化报告任务状态
                </h3>
                <div class="p-4 text-gray-500">暂无活跃的自动化报告任务配置。</div>
              `;
              return;
            }

            let htmlContent = `
              <h3 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-clock-o text-primary mr-2"></i>自动化报告任务状态
              </h3>
              <div class="space-y-3">
            `;

            statusData.forEach(task => {
              const statusClass = task.last_run_status === 'SUCCESS' ? 'bg-green-100 text-green-800' : 
                                  task.last_run_status === 'FAILED' ? 'bg-red-100 text-red-800' : 
                                  'bg-gray-100 text-gray-800';
              
              htmlContent += `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                  <div class="flex justify-between items-center mb-2">
                    <div class="font-medium text-gray-900">${task.report_title_template} (${task.report_type})\u003c/div>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                      ${task.last_run_status || '未知'}
                    </span>
                  </div>
                  <p class="text-sm text-gray-600">上次运行: ${task.last_run_timestamp || 'N/A'}</p>
                  ${task.last_run_status === 'FAILED' && task.description ? `<p class="text-sm text-red-600">错误详情: ${task.description}</p>` : ''}
                </div>
              `;
            });

            htmlContent += `</div>`;
            container.innerHTML = htmlContent;

          } catch (e) {
            handleFailure(e);
            container.innerHTML = `
              <h3 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-clock-o text-primary mr-2"></i>自动化报告任务状态
              </h3>
              <div class="p-4 text-red-500">加载自动化任务状态失败: ${e.message}</div>
            `;
          }
        },

        // ✅ 辅助函数：处理全选/取消全选
        toggleAllTechAreas: function(event) {
          const isChecked = event.target.checked;
          document.querySelectorAll('input[name="tech-area-checkbox"]:not(#all-tech-areas)').forEach(cb => {
            if (!cb.disabled) { // 只改变未被禁用的复选框
              cb.checked = isChecked;
            }
          });
        },

        // ✅ 辅助函数：处理单个技术领域复选框变化
        handleSingleTechAreaChange: function() {
          const allTechCheckbox = document.getElementById('all-tech-areas');
          const otherCheckboxes = document.querySelectorAll('input[name="tech-area-checkbox"]:not(#all-tech-areas)');
          const allOthersChecked = Array.from(otherCheckboxes).every(cb => cb.checked || cb.disabled); // 如果所有未禁用的都选中了
          if (allTechCheckbox && allOthersChecked) {
            allTechCheckbox.checked = true;
          } else if (allTechCheckbox) {
            allTechCheckbox.checked = false;
          }
        },

        // ✅ 辅助函数：处理周期变化事件 (包括日期选择)
        handlePeriodChange: function() {
          App.pageInitializers.reports.toggleCustomDateInputs(); // 切换自定义日期输入框显示
          App.pageInitializers.reports.updateTechAreasBasedOnPeriod(); // 更新技术领域复选框状态
        },

        // ✅ 辅助函数：根据周期更新技术领域复选框状态
        updateTechAreasBasedOnPeriod: async function() {
          const selectedPeriodType = document.querySelector('input[name="report-period"]:checked').value;
          const startDateInput = document.getElementById('startDate');
          const endDateInput = document.getElementById('endDate');

          let periodStart, periodEnd;
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          switch (selectedPeriodType) {
            case 'weekly':
              periodEnd = new Date(today);
              periodStart = new Date(today);
              periodStart.setDate(today.getDate() - 7);
              break;
            case 'monthly':
              periodEnd = new Date(today);
              periodStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
              break;
            case 'quarterly':
              periodEnd = new Date(today);
              periodStart = new Date(today.getFullYear(), today.getMonth() - 3, 1);
              break;
            case 'annual':
              periodEnd = new Date(today);
              periodStart = new Date(today.getFullYear() - 1, 0, 1);
              break;
            case 'custom':
              periodStart = new Date(startDateInput.value);
              periodEnd = new Date(endDateInput.value);
              break;
            default: // 默认为周度或日报，如果类型不匹配
                periodEnd = new Date(today);
                periodStart = new Date(today);
                if (selectedPeriodType === 'Daily') { /* 周期为今天 */ }
                else { periodStart.setDate(today.getDate() - 7); } // 默认周度
                break;
          }

          // 格式化日期为 YYYY-MM-DD 字符串
          const formatToYYYYMMDD = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
          };
          const periodStartStr = formatToYYYYMMDD(periodStart);
          const periodEndStr = formatToYYYYMMDD(periodEnd);

          // 如果日期无效或未选择，则不调用后端
          if (isNaN(periodStart.getTime()) || isNaN(periodEnd.getTime())) {
            App.pageInitializers.reports.renderTechAreaCheckboxes(this.allAvailableTechAreas); // 重新渲染全部可选，不禁用
            return;
          }

          try {
            const techAreasWithInsights = await App.callApi('ReportsService', 'getTechAreasWithInsightsInPeriod', [periodStartStr, periodEndStr]);
            this.renderTechAreaCheckboxes(this.allAvailableTechAreas, techAreasWithInsights);
          } catch (e) {
            console.error("Error updating tech areas based on period:", e);
            // 如果后端调用失败，则显示所有技术领域，不禁用
            this.renderTechAreaCheckboxes(this.allAvailableTechAreas); 
          }
        },
        // **新增：上一页函数**
        prevReportsHistoryPage: async function() {
          if (App.reportsHistoryCurrentPage > 1) {
            App.reportsHistoryCurrentPage--;
            await App.pageInitializers.reports.loadReportsHistory();
          }
        },

        // **新增：下一页函数**
        nextReportsHistoryPage: async function() {
          if (App.reportsHistoryCurrentPage < App.reportsHistoryTotalPages) {
            App.reportsHistoryCurrentPage++;
            await App.pageInitializers.reports.loadReportsHistory();
          }
        },

        // 加载报告历史记录
        loadReportsHistory: async function() {
          const tableBody = document.getElementById('reportHistoryTable');
          const paginationInfoSpan = document.getElementById('reportsHistoryPaginationInfo');
          const prevBtn = document.getElementById('reportsHistoryPrevPageBtn');
          const nextBtn = document.getElementById('reportsHistoryNextPageBtn');
          
          if (!tableBody || !paginationInfoSpan || !prevBtn || !nextBtn) {
            console.error("错误: 未能找到所有报告历史的分页元素。");
            return;
          }

          tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">正在加载报告历史...</td></tr>`;
          paginationInfoSpan.textContent = '加载中...';
          prevBtn.disabled = true;
          nextBtn.disabled = true;

          try {
            const response = await App.callApi('ReportsService', 'getReportsHistory', [App.reportsHistoryCurrentPage, App.reportsHistoryItemsPerPage]);
            
            // ✅ 增加对 response 本身的检查
            if (!response || !response.records) {
                throw new Error("后端返回的数据结构不正确。");
            }

            // ✅ 关键修正：即使 response 为空，也进行安全处理
            const reports = response ? response.records : [];
            const totalRecords = response ? response.totalRecords : 0;

            App.reportsHistoryTotalRecords = totalRecords;
            App.reportsHistoryTotalPages = Math.ceil(totalRecords / App.reportsHistoryItemsPerPage) || 1;

            if (reports && reports.length > 0) {
              const reportStatusClasses = {
                'Generated': { text: '已发布', classes: 'bg-green-100 text-green-800' },
                'Generated_Email_Failed': { text: '邮件失败', classes: 'bg-yellow-100 text-yellow-800' },
                'Failed': { text: '生成失败', classes: 'bg-red-100 text-red-800' },
                'default': { text: '未知', classes: 'bg-gray-100 text-gray-800' }
              };

              tableBody.innerHTML = reports.map(report => {
                // ✅ 对 report 对象本身进行最终的、最安全的检查
                if (!report) return ''; // 如果整条记录是 null，直接跳过

                // ✅ 关键修正：为每个可能为空的字段提供默认值
                const statusKey = report.status || 'default';
                const statusInfo = reportStatusClasses[statusKey] || reportStatusClasses['default'];
                
                const downloadHtml = report.download_url ?
                    `<a href="${report.download_url}" target="_blank" class="text-primary hover:text-primary-dark mr-3">查看</a>
                    <a href="${report.download_url}" download="${report.report_name || 'report'}.html" class="text-gray-500 hover:text-gray-700">下载</a>` :
                    `<span class="text-gray-400">无文件</span>`;
                
                // ✅ 核心修正：即使 download_url 存在，也为文件名提供默认值
                const downloadLink = report.download_url ? 
                    `<a href="${report.download_url}" download="${report.report_name || 'report'}.html" class="text-gray-500 hover:text-gray-700">下载</a>` : '';

                // ✅ 对每个字段都使用 || 'N/A' 来提供默认值
                return `
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap"><div class="font-medium text-gray-900" title="${report.report_name || ''}">${report.report_name || 'N/A'}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${report.report_type || 'N/A'}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${report.generation_date || 'N/A'}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${report.generated_by || 'N/A'}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo.classes}">${statusInfo.text}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${downloadHtml}</td>
                  </tr>
                `;
              }).join('');
            } else {
              tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">暂无报告历史记录。</td></tr>`;
            }

            paginationInfoSpan.textContent = `第 ${App.reportsHistoryCurrentPage} / ${App.reportsHistoryTotalPages} 页 (共 ${App.reportsHistoryTotalRecords} 条)`;
            prevBtn.disabled = App.reportsHistoryCurrentPage === 1;
            nextBtn.disabled = App.reportsHistoryCurrentPage >= App.reportsHistoryTotalPages;

          } catch (e) {
            // ✅ 修正：提供更具体的错误信息
            console.error("加载报告历史失败:", e);
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">加载报告历史失败: ${e.message}</td></tr>`;
            // 不再调用会产生误导性弹窗的 handleFailure
          }
        },

        // 切换自定义日期输入框的显示/隐藏
        toggleCustomDateInputs: function() {
          const customRadio = document.getElementById('custom');
          const customDateDiv = document.getElementById('customDateRange');
          if (customRadio.checked) {
            customDateDiv.classList.remove('hidden');
          } else {
            customDateDiv.classList.add('hidden');
          }
        },

        // 处理生成报告按钮点击事件
        handleGenerateReport: async function() {
          // 1. 获取表单数据
          const reportTypeSelect = document.querySelector('select[name="report-type-select"]');
          const reportType = reportTypeSelect.value;
          const reportTitleInput = document.querySelector('input[name="report-title-input"]');
          const reportTitle = reportTitleInput.value.trim();
          
          const periodRadios = document.querySelectorAll('input[name="report-period"]');
          let selectedPeriodType = 'weekly'; // 默认周度
          periodRadios.forEach(radio => {
            if (radio.checked) {
              selectedPeriodType = radio.value;
            }
          });

          const startDateInput = document.getElementById('startDate');
          const endDateInput = document.getElementById('endDate');
          
          const techAreaCheckboxes = document.querySelectorAll('input[name="tech-area-checkbox"]:checked');
          const techAreas = Array.from(techAreaCheckboxes).map(cb => cb.value);

          const targetAudienceSelect = document.querySelector('select[name="target-audience-select"]');
          const targetAudience = targetAudienceSelect.value;

          const reportOwnerInput = document.querySelector('input[name="report-owner-input"]');
          const reportOwner = reportOwnerInput.value.trim();

          const reportSummaryTextarea = document.querySelector('textarea[name="report-summary-textarea"]');
          const reportSummary = reportSummaryTextarea.value.trim();

          const recipientEmailInput = document.getElementById('recipient-email-input'); // ✅ 新增接收者邮箱输入框
          const recipientEmail = recipientEmailInput ? recipientEmailInput.value.trim() : ''; 

          // 2. 验证输入
          if (!reportTitle) { alert('请输入报告标题。'); return; }
          if (!reportOwner) { alert('请输入报告负责人。'); return; }
          if (!reportSummary) { alert('请输入报告摘要。'); return; }
          if (selectedPeriodType === 'custom' && (!startDateInput.value || !endDateInput.value)) {
            alert('请选择自定义报告的开始和结束日期。');
            return;
          }

          // 3. 计算报告周期日期
          let periodStart, periodEnd;
          const today = new Date();
          today.setHours(0, 0, 0, 0); // 将时间设为00:00:00，避免当天数据丢失

          switch (selectedPeriodType) {
            case 'weekly':
              periodEnd = new Date(today);
              periodStart = new Date(today);
              periodStart.setDate(today.getDate() - 7);
              break;
            case 'monthly':
              periodEnd = new Date(today);
              periodStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
              break;
            case 'quarterly':
              periodEnd = new Date(today);
              periodStart = new Date(today.getFullYear(), today.getMonth() - 3, 1);
              break;
            case 'annual':
              periodEnd = new Date(today);
              periodStart = new Date(today.getFullYear() - 1, 0, 1);
              break;
            case 'custom':
              periodStart = new Date(startDateInput.value);
              periodEnd = new Date(endDateInput.value);
              break;
            default:
              alert('请选择报告周期。');
              return;
          }

          // 格式化日期为 YYYY-MM-DD 字符串
          const formatToYYYYMMDD = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
          };
          const periodStartStr = formatToYYYYMMDD(periodStart);
          const periodEndStr = formatToYYYYMMDD(periodEnd);

          // 4. 调用后端API生成报告
          try {
            document.getElementById('generateReportBtn').disabled = true; // 禁用按钮防止重复点击
            document.getElementById('generateReportBtn').textContent = '生成中...';

            const result = await App.callApi('ReportsService', 'generateReport', [
              reportType, 
              reportTitle, 
              periodStartStr, 
              periodEndStr, 
              techAreas, 
              targetAudience, 
              reportOwner, 
              reportSummary,
              recipientEmail
            ]);

            if (result.success) {
              alert('报告生成成功！请在报告历史中查看或下载。');
              // 刷新历史记录
              App.pageInitializers.reports.loadReportsHistory(); 
              // 可选：清空表单
              reportTitleInput.value = '';
              document.getElementById('weekly').checked = true; // 恢复默认周度
              App.pageInitializers.reports.toggleCustomDateInputs();
              techAreaCheckboxes.forEach(cb => cb.checked = false); // 取消所有技术领域选择
              targetAudienceSelect.value = '技术团队';
              reportOwnerInput.value = '';
              reportSummaryTextarea.value = '';

            } else {
              alert('报告生成失败：' + (result.message || '未知错误。'));
            }
          } catch (e) {
            handleFailure(e);
            alert('报告生成请求失败。详情请查看浏览器控制台。');
          } finally {
            document.getElementById('generateReportBtn').disabled = false;
            document.getElementById('generateReportBtn').textContent = '生成报告';
          }
        }
      },
      // ✅ 新增：系统工作台页面的初始化器
      system: {
        // --- 核心属性 ---
        isInitialized: false,
        activeRegistryKey: null, // 存储当前查看的注册表键名，例如 'TECH_REGISTRY'
        registryConfigs: [],     // 保存所有注册表的配置信息
        currentEditDocId: null,  // 存储正在编辑的文档ID，在'添加'模式下为null
        // ✅ 新增：用于排序和筛选的状态管理
        fullDataset: [], // 存储从后端获取的完整、未经修改的数据
        currentSort: { key: null, order: 'none' }, // e.g., { key: 'tech_name', order: 'asc' }
        currentFilter: '', // 存储当前的搜索关键词

        // --- 初始化与事件处理 ---

        init: function() {
          if (this.isInitialized) {
            // 如果已经初始化，只需确保显示正确的数据
            if (this.activeRegistryKey) this.loadRegistryData(this.activeRegistryKey);
            return;
          }
          
          console.log("正在初始化系统管理页面...");
          this.setupAllConfigs(); // ✅ 确保调用的是这个新函数名
          this.bindEventListeners();

          // 默认加载第一个注册表
          // const firstRegistryKey = this.registryConfigs[0]?.key;
          // if (firstRegistryKey) {
          //   this.switchRegistryTab(firstRegistryKey);
          // }

          this.switchSubTab('registries'); 
          this.isInitialized = true;
        },

          bindEventListeners: function() {
            const pageSystem = document.getElementById('page-system');
            if (!pageSystem) return;

            pageSystem.addEventListener('click', (e) => {
              const subTabLink = e.target.closest('a.system-sub-tab');
              if (subTabLink) {
                e.preventDefault();
                this.switchSubTab(subTabLink.dataset.subTab);
                return;
              }
              
              const registryTabLink = e.target.closest('a.registry-tab');
              if (registryTabLink) {
                e.preventDefault();
                this.switchRegistryTab(registryTabLink.dataset.registry);
                return;
              }

              const actionButton = e.target.closest('button[data-action]');
              if (actionButton) {
                const action = actionButton.dataset.action;
                const docId = actionButton.dataset.docId;
                this.handleRegistryActionClick(action, docId);
                return;
              }

              const header = e.target.closest('.sortable-header');
              if (header) {
                const sortKey = header.dataset.sortKey;
                if (!sortKey) return;
                if (this.currentSort.key === sortKey) {
                  this.currentSort.order = this.currentSort.order === 'asc' ? 'desc' : 'asc';
                } else {
                  this.currentSort.key = sortKey;
                  this.currentSort.order = 'asc';
                }
                this.applyFiltersAndSort();
              }
            });
            
            // 模态框事件
            document.getElementById('saveRegistryEntryBtn').addEventListener('click', this.handleSaveRegistryEntry.bind(this));
            const modal = document.getElementById('registryEntryModal');
            modal.querySelector('.close-button').addEventListener('click', () => this.hideRegistryFormModal());
            modal.addEventListener('click', (e) => {
                if (e.target.id === 'registryEntryModal') this.hideRegistryFormModal();
            });
          },

        // --- UI渲染与模态框逻辑 ---

        // 动态构建并显示用于添加或编辑条目的表单模态框
        showRegistryFormModal: async function(action, docId = null) {
            this.currentEditDocId = docId;
            const config = this.getRegistryConfig(this.activeRegistryKey);
            if (!config) return;

            const modalTitle = document.getElementById('registryModalTitle');
            const form = document.getElementById('registryEntryForm');
            form.innerHTML = ''; // 清空旧表单

            modalTitle.textContent = `${action === 'add' ? '添加新' : '编辑'}${config.title}`;

            let currentData = {};
            if (action === 'edit' && docId) {
                try {
                    const allData = await App.callApi('SystemAdminService', 'getRegistry', [this.activeRegistryKey]);
                    currentData = allData.find(item => (item[config.idField] || item.id) === docId);
                    if (!currentData) {
                        alert('错误：找不到要编辑的记录。');
                        return;
                    }
                } catch(e) {
                    handleFailure(e);
                    return;
                }
            }

            // ✅ 核心优化：将字段分为常规字段和复选框字段
            const regularFields = config.fields.filter(f => f.type !== 'checkbox');
            const checkboxFields = config.fields.filter(f => f.type === 'checkbox');

            // 1. 渲染常规字段
            regularFields.forEach(field => {
              const value = currentData[field.name] || '';
              let fieldHtml = '';
              const inputId = `form-field-${field.name}`;
              const isRequired = field.required ? '<span class="text-red-500">*</span>' : '';

              switch (field.type) {
                case 'textarea':
                  fieldHtml = `<textarea id="${inputId}" name="${field.name}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary text-sm" rows="3">${value}</textarea>`;
                  break;
                case 'select':
                  const optionsHtml = field.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('');
                  fieldHtml = `<select id="${inputId}" name="${field.name}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary text-sm">${optionsHtml}</select>`;
                  break;
                default:
                  fieldHtml = `<input type="${field.type}" id="${inputId}" name="${field.name}" value="${value}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary focus:border-primary text-sm" placeholder="${field.placeholder || ''}">`;
                  break;
              }
              // ✅ 优化：减小了 mb-4 到 mb-3
              form.innerHTML += `
                <div class="mb-3">
                  <label for="${inputId}" class="block text-sm font-medium text-gray-700">${field.label} ${isRequired}</label>
                  ${fieldHtml}
                </div>`;
            });

            // 2. 如果存在复选框字段，则渲染为一个分组
            if (checkboxFields.length > 0) {
                const checkboxesHtml = checkboxFields.map(field => {
                    const value = currentData[field.name] || false;
                    const inputId = `form-field-${field.name}`;
                    return `
                        <div class="flex items-center">
                            <input type="checkbox" id="${inputId}" name="${field.name}" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" ${value ? 'checked' : ''}>
                            <label for="${inputId}" class="ml-2 block text-sm text-gray-800">${field.label}</label>
                        </div>
                    `;
                }).join('');

                // ✅ 优化：使用网格布局来展示复选框
                form.innerHTML += `
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">数据源监控选项</label>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            ${checkboxesHtml}
                        </div>
                    </div>
                `;
            }

            document.getElementById('registryEntryModal').style.display = 'flex';
        },

        // 隐藏表单模态框
        hideRegistryFormModal: function() {
          document.getElementById('registryEntryModal').style.display = 'none';
          this.currentEditDocId = null;
        },

        // 渲染当前激活的注册表的数据表格
        renderRegistryTable: function(dataToRender) {
          const config = this.getRegistryConfig(this.activeRegistryKey);
          if (!config) return;

          // ✅ 核心修改：动态地找到正确的表格包装器ID
          const tableWrapperId = `registry-table-wrapper-${this.activeRegistryKey}`;
          const tableWrapper = document.getElementById(tableWrapperId);

          if (!tableWrapper) {
              console.error(`渲染错误: 找不到表格包装器 #${tableWrapperId}`);
              return;
          }

          // --- 动态表头生成 (此部分逻辑不变) ---
          const getTableHeaders = () => {
            // 辅助函数，用于生成单个可排序的表头
            const renderHeader = (label, sortKey, alignment = 'center') => {
                // ✅ 核心修改：调整基础样式
                const headerBaseClasses = `px-4 py-2 text-${alignment} text-base font-semibold text-gray-800 uppercase tracking-wider`;
                if (!sortKey) {
                    return `<th class="${headerBaseClasses}">${label}</th>`;
                }
                const isSorted = this.currentSort.key === sortKey;
                let iconClass = 'fa-sort';
                if (isSorted) {
                    iconClass = this.currentSort.order === 'asc' ? 'fa-sort-asc' : 'fa-sort-desc';
                }
                return `
                    <th class="${headerBaseClasses} sortable-header" data-sort-key="${sortKey}">
                        <div class="flex items-center justify-${alignment}">
                            <span>${label}</span>
                            <i class="fa ${iconClass} sort-icon ${isSorted ? 'active' : ''}"></i>
                        </div>
                    </th>`;
            };
            
            // 为特定注册表定义定制化、更精细的表头
            // ✅ 核心修改：明确指定每一列的对齐方式
            const customHeaders = {
                'TECH_REGISTRY': 
                    renderHeader('技术领域', 'tech_name', 'center') + // 左对齐
                    renderHeader('技术关键词', 'tech_keywords', 'center') + // 左对齐
                    renderHeader('状态', 'monitoring_status', 'center') + // 居中
                    renderHeader('数据源', null, 'center') + // 居中 (不可排序)
                    renderHeader('操作', null, 'center'), // 右对齐 (不可排序)
                'COMPETITOR_REGISTRY': 
                    renderHeader('公司名称', 'company_name', 'center', 'w-1/4') +
                    renderHeader('状态', 'monitoring_status', 'center', 'w-[10%]') +
                    renderHeader('优先级', 'monitoring_priority', 'center', 'w-[10%]') +
                    renderHeader('技术焦点', null, 'center', 'w-1/3') +
                    renderHeader('官方网站', null, 'center', 'w-1/6') +
                    renderHeader('操作', null, 'center'),
                'CONFERENCE_REGISTRY': 
                    renderHeader('会议名称', 'conference_name', 'center') + // 左对齐
                    renderHeader('行业焦点', 'industry_focus', 'center') + // 左对齐
                    renderHeader('状态', 'monitoring_status', 'center') + // 居中
                    renderHeader('官方网站', null, 'center') + // 左对齐 (不可排序)
                    renderHeader('操作', null, 'center') // 右对齐 (不可排序)
            };
            
            if (customHeaders[config.key]) {
                return customHeaders[config.key];
            }
            
            // 默认表头逻辑（现在也支持对齐）
            return config.fields.map(f => renderHeader(f.label, f.name, 'left')).join('') + 
                  renderHeader('操作', null, 'right');
        };

          // --- 动态表格行生成 (此部分逻辑不变) ---
          const getTableRows = (data) => {
            // ... 此处粘贴你上一版回复中 `renderRegistryTable` 函数内部的 `getTableRows` 完整函数体 ...
            // 为了确保完整性，我再次粘贴一遍
            const renderActionButtons = (docId) => `
                <button data-action="edit" data-doc-id="${docId}" class="action-icon-button" title="编辑"><i class="fa fa-pencil-square-o text-lg"></i></button>
                <button data-action="delete" data-doc-id="${docId}" class="action-icon-button ml-4 hover:text-red-500" title="删除"><i class="fa fa-trash-o text-lg"></i></button>`;

            const renderStatusBadge = (status) => `<span class="badge ${status === 'active' ? 'badge-success' : 'badge-inactive'}">${status}</span>`;
            
            const renderClickableLink = (url) => {
                if (!url || typeof url !== 'string' || !url.startsWith('http')) return '<span class="text-sm text-gray-400">未提供</span>';
                const cleanUrl = url.replace(/^https?:\/\//, '').replace(/\/$/, '');
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-200 text-base">${cleanUrl}</a>`;
            };

            switch (config.key) {
                case 'TECH_REGISTRY':
                    return data.map(item => {
                      const docId = item.id;
                      const keywordsHtml = (item.tech_keywords || '').split(',').map(kw => kw.trim()).filter(kw => kw).map(kw => `<span class="inline-block bg-blue-100 text-blue-800 text-sm font-medium mr-1.5 mb-1.5 px-3 py-1 rounded-md">${kw}</span>`).join('');
                      const sourcesHtml = ['data_source_academic', 'data_source_patent', 'data_source_opensource', 'data_source_news'].map(s => item[s] ? `<i class="fa fa-check-circle text-green-500 text-xl mx-1.5"></i>` : `<i class="fa fa-circle-o text-gray-300 text-xl mx-1.5"></i>`).join('');
                      
                      return `<tr class="hover:bg-gray-50/70 transition-colors duration-200">
                                  <td class="px-6 py-3 w-2/5">
                                      <div class="text-base font-semibold text-gray-900">${item.tech_name}</div>
                                      <div class="text-sm text-gray-500">${item.tech_category}</div>
                                  </td>
                                  <td class="px-6 py-3 w-2/5">
                                      <div class="flex flex-wrap">${keywordsHtml || '<span class="text-sm text-gray-400">未设置</span>'}</div>
                                  </td>
                                  <td class="px-6 py-3 w-1/12 text-center">${renderStatusBadge(item.monitoring_status)}</td>
                                  <td class="px-6 py-3 w-1/6 text-center">
                                      <div class="flex justify-center items-center">${sourcesHtml}</div>
                                  </td>
                                  <td class="px-6 py-3 w-auto text-right">${renderActionButtons(docId)}</td>
                              </tr>`;
                  }).join('');
                case 'COMPETITOR_REGISTRY':
                        return data.map(item => {
                          const docId = item.id;
                          const priority = item.monitoring_priority || 'low';
                          let priorityBadge = '';
                          if (priority === 'high') priorityBadge = `<span class="badge badge-danger">高</span>`;
                          else if (priority === 'medium') priorityBadge = `<span class="badge" style="background-color:#FEF3C7; color:#92400E;">中</span>`;
                          else priorityBadge = `<span class="badge badge-inactive">低</span>`;

                          const focusHtml = (item.tech_focus_areas || '')
                              .split(',')
                              .map(kw => kw.trim()).filter(kw => kw)
                              .slice(0, 3)
                              .map(kw => `<span class="inline-block bg-gray-200 text-gray-800 text-xs font-medium mr-1.5 mb-1.5 px-2 py-0.5 rounded">${kw}</span>`)
                              .join('');

                          return `<tr class="hover:bg-gray-50/70 transition-colors duration-200">
                                      <td class="px-6 py-2">
                                          <div class="text-base font-semibold text-gray-900">${item.company_name}</div>
                                          <div class="text-sm text-gray-500">${item.industry_category || 'N/A'}</div>
                                      </td>
                                      <td class="px-6 py-2 text-center">${renderStatusBadge(item.monitoring_status)}</td>
                                      <td class="px-6 py-2 text-center">${priorityBadge}</td>
                                      <td class="px-6 py-2">
                                          <div class="flex flex-wrap items-center">${focusHtml || '<span class="text-xs text-gray-400">未设置</span>'}</div>
                                      </td>
                                      <td class="px-6 py-2">${renderClickableLink(item.website_url)}</td>
                                      <td class="px-6 py-2 text-right">${renderActionButtons(docId)}</td>
                                  </tr>`;
                      }).join('');
                case 'CONFERENCE_REGISTRY':
                    return data.map(item => {
                        const docId = item.id;
                        return `<tr class="hover:bg-gray-50/70 transition-colors duration-200">
                                    <td class="px-6 py-3"><div class="text-base font-semibold text-gray-900">${item.conference_name}</div></td>
                                    <td class="px-6 py-3 text-base text-gray-600">${item.industry_focus}</td>
                                    <td class="px-6 py-3 text-center">${renderStatusBadge(item.monitoring_status)}</td>
                                    <td class="px-6 py-3">${renderClickableLink(item.official_website)}</td>
                                    <td class="px-6 py-3 text-right">${renderActionButtons(docId)}</td>
                                </tr>`;
                    }).join('');
                default:
                    return data.map(item => {
                        const docId = item.id;
                        const cells = config.fields.map(f => `<td class="px-6 py-3 text-base text-gray-800">${item[f.name] || 'N/A'}</td>`).join('');
                        return `<tr class="hover:bg-gray-50/70">${cells}<td class="px-6 py-3 text-right">${renderActionButtons(docId)}</td></tr>`;
                    }).join('');
            }
          };

          // --- 最终HTML结构 ---
          tableWrapper.innerHTML = `
            <div class="w-full">
              <table id="registry-dynamic-table" class="min-w-full border border-navDark rounded-lg overflow-hidden">
                <thead class="bg-gray-800/5"> 
                  <tr>${getTableHeaders()}</tr>
                </thead>
                <tbody class="divide-y divide-navDark/30"> 
                  ${dataToRender.length > 0 ? getTableRows(dataToRender) : `<tr><td colspan="100%" class="text-center py-16 text-gray-500 text-lg">没有匹配的数据</td></tr>`}
                </tbody>
              </table>
            </div>`;
        },
        
        // --- 数据与API交互 ---
        // ✅ 新增：核心处理函数
        applyFiltersAndSort: function() {
          let processedData = [...this.fullDataset]; // 从完整数据开始

          // 1. 应用筛选
          if (this.currentFilter) {
            processedData = processedData.filter(item => {
              // 将整个对象的值拼接成一个字符串进行搜索，简单高效
              return Object.values(item).join(' ').toLowerCase().includes(this.currentFilter);
            });
          }

          // 2. 应用排序
          const sortInfo = this.currentSort;
          if (sortInfo.key && sortInfo.order !== 'none') {
            processedData.sort((a, b) => {
              let valA = a[sortInfo.key] || '';
              let valB = b[sortInfo.key] || '';
              
              // 尝试将值转为数字进行比较，失败则按字符串比较
              const numA = parseFloat(valA);
              const numB = parseFloat(valB);

              let comparison = 0;
              if (!isNaN(numA) && !isNaN(numB)) {
                comparison = numA - numB;
              } else {
                comparison = String(valA).localeCompare(String(valB), 'zh-Hans-CN');
              }
              
              return sortInfo.order === 'asc' ? comparison : -comparison;
            });
          }

          // 3. 调用渲染函数，传入处理后的数据
          this.renderRegistryTable(processedData);
        },


        // 获取所选注册表的数据并触发渲染
        loadRegistryData: async function(registryKey) {
          // 决定在哪个主容器里进行操作
          const containerId = this.reportConfigs.some(c => c.key === registryKey)
              ? 'current-report-registry-content' 
              : 'current-registry-content';
          const contentContainer = document.getElementById(containerId);
          
          const config = this.getRegistryConfig(registryKey);
          if (!contentContainer || !config) return;

          // 渲染包含操作区和表格包装器的完整骨架屏
          // ✅ 核心修改：为表格包装器使用唯一的ID
          const tableWrapperId = `registry-table-wrapper-${registryKey}`;
          contentContainer.innerHTML = `
            <div class="flex justify-between items-center">
              <div class="relative w-1/3 max-w-xs">
                <input type="text" id="registry-search-input" placeholder="搜索 ${config.title}..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              </div>
              <div>
                <button data-action="add" class="px-5 py-2 bg-primary text-white font-semibold rounded-lg hover:bg-blue-700 shadow-sm flex items-center">
                  <i class="fa fa-plus mr-2"></i> 添加新${config.title}
                </button>
              </div>
            </div>
            <div id="${tableWrapperId}" class="mt-3 text-center p-8">正在加载数据...</div>`;

          // 为新生成的搜索框绑定事件
          contentContainer.querySelector(`#registry-search-input`).addEventListener('input', (e) => {
            this.currentFilter = e.target.value.trim().toLowerCase();
            this.applyFiltersAndSort();
          });

          try {
            const data = await App.callApi('SystemAdminService', 'getRegistry', [registryKey]);
            this.fullDataset = data || [];
            this.currentSort = { key: null, order: 'none' };
            this.currentFilter = '';
            this.applyFiltersAndSort(); // 首次渲染
          } catch (e) {
            document.getElementById(tableWrapperId).innerHTML = `<div class="p-8 text-red-500">加载 ${config.title} 数据失败: ${e.message}</div>`;
            handleFailure(e);
          }
        },

        // 处理表格中的“添加”、“编辑”、“删除”按钮点击事件
        handleRegistryActionClick: function(action, docId) {
          const config = this.getRegistryConfig(this.activeRegistryKey);
          if (!config) return;

          if (action === 'delete') {
            if (confirm(`确定要删除这个${config.title}吗？\nID: ${docId}`)) {
              const deleteButton = document.querySelector(`button[data-action="delete"][data-doc-id="${docId}"]`);
              if(deleteButton) {
                  deleteButton.textContent = '删除中...';
                  deleteButton.disabled = true;
              }
              
              App.callApi('SystemAdminService', 'deleteRegistryEntry', [this.activeRegistryKey, docId])
                .then(() => {
                  alert('删除成功！');
                  this.loadRegistryData(this.activeRegistryKey); // 刷新表格
                })
                .catch(handleFailure);
            }
          } else if (action === 'add' || action === 'edit') {
            this.showRegistryFormModal(action, docId);
          }
        },

        // 处理模态框中的“保存”按钮点击事件
        handleSaveRegistryEntry: function() {
          const config = this.getRegistryConfig(this.activeRegistryKey);
          if (!config) return;

          const form = document.getElementById('registryEntryForm');
          const formData = new FormData(form);
          const entryData = {};

          // 从表单字段中收集数据
          config.fields.forEach(field => {
            if (field.type === 'checkbox') {
              entryData[field.name] = form.querySelector(`[name="${field.name}"]`).checked;
            } else {
              entryData[field.name] = formData.get(field.name);
            }
          });

          const saveBtn = document.getElementById('saveRegistryEntryBtn');
          saveBtn.textContent = '保存中...';
          saveBtn.disabled = true;

          const action = this.currentEditDocId ? 'update' : 'add';
          const apiMethod = action === 'add' ? 'addRegistryEntry' : 'updateRegistryEntry';
          const apiArgs = action === 'add' 
            ? [this.activeRegistryKey, entryData]
            : [this.activeRegistryKey, this.currentEditDocId, entryData];

          App.callApi('SystemAdminService', apiMethod, apiArgs)
            .then(() => {
              alert('保存成功！');
              this.hideRegistryFormModal();
              this.loadRegistryData(this.activeRegistryKey); // 刷新表格
            })
            .catch(handleFailure)
            .finally(() => {
              saveBtn.textContent = '保存';
              saveBtn.disabled = false;
            });
        },

        loadReportConfigContent: function() {
            const container = document.getElementById('system-tab-content-reports-mgmt');
            if (!container || container.querySelector('.registry-tabs')) return;

            const reportTabsHtml = this.reportConfigs.map(conf => 
                `<a href="#" class="registry-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-base text-gray-500 border-transparent" data-registry="${conf.key}">${conf.title}</a>`
            ).join('');

            container.innerHTML = `
              <div class="border-b border-gray-200">
                  <nav class="registry-tabs -mb-px flex space-x-4" aria-label="Report Registry Tabs">
                      ${reportTabsHtml}
                  </nav>
              </div>
              <div id="current-report-registry-content" class="mt-4"></div>
            `;
        },

        // ✅ 将配置设置分为两部分
        setupAllConfigs: function() {
          this.registryConfigs = [
            {
              key: 'TECH_REGISTRY', title: '技术领域', idField: 'tech_id',
              fields: [
                { name: 'tech_name', label: '技术名称', type: 'text', required: true },
                { name: 'tech_category', label: '技术类别', type: 'text', required: true },
                { name: 'tech_keywords', label: '技术关键词 (逗号分隔)', type: 'textarea' },
                { name: 'monitoring_status', label: '监控状态', type: 'select', options: ['active', 'inactive'], required: true },
                { name: 'data_source_academic', label: '监控学术论文', type: 'checkbox' },
                { name: 'data_source_patent', label: '监控专利', type: 'checkbox' },
                { name: 'data_source_opensource', label: '监控开源项目', type: 'checkbox' },
                { name: 'data_source_news', label: '监控技术新闻', type: 'checkbox' },
              ]
            },   
            {
                key: 'COMPETITOR_REGISTRY',
                title: '业界标杆',
                idField: 'competitor_id',
                // ✅ 使用全新的、更丰富的字段配置，并优化了顺序
                fields: [
                  { name: 'company_name', label: '公司名称', type: 'text', required: true },
                  { name: 'industry_category', label: '行业类别', type: 'text' },
                  { name: 'stock_symbol', label: '股票代码', type: 'text' },
                  { name: 'website_url', label: '官方网站', type: 'url' },
                  { name: 'tech_focus_areas', label: '技术焦点 (逗号分隔)', type: 'textarea' },
                  { name: 'monitoring_status', label: '监控状态', type: 'select', options: ['active', 'inactive'], required: true },
                  { name: 'monitoring_priority', label: '监控优先级', type: 'select', options: ['high', 'medium', 'low'] },
                  { name: 'threat_level', label: '威胁等级', type: 'select', options: ['high', 'medium', 'low'] },
                  { name: 'employee_count', label: '员工数', type: 'number' },
                  { name: 'annual_revenue', label: '年收入(美元)', type: 'number' },
                  { name: 'notes', label: '备注', type: 'textarea' },
                  { name: 'rss_url', label: '新闻RSS链接', type: 'url' },
                  { name: 'news_monitoring', label: '监控新闻', type: 'checkbox' },
                  { name: 'patent_monitoring', label: '监控专利', type: 'checkbox' },
                  { name: 'social_monitoring', label: '监控社交媒体', type: 'checkbox' },
                ]
              },
            {
              key: 'CONFERENCE_REGISTRY', title: '学术顶会', idField: 'conference_id',
              fields: [
                { name: 'conference_name', label: '会议名称', type: 'text', required: true },
                { name: 'industry_focus', label: '行业焦点', type: 'text' },
                { name: 'monitoring_status', label: '监控状态', type: 'select', options: ['active', 'inactive'] },
                { name: 'official_website', label: '官方网站', type: 'url' },
              ]
            }
          ];
          
          this.reportConfigs = [
            {
              key: 'REPORT_RECIPIENTS', title: '报告接收者', idField: 'recipient_id',
              fields: [
                  { name: 'recipient_name', label: '姓名', type: 'text', required: true },
                  { name: 'recipient_email', label: '邮箱', type: 'email', required: true },
                  { name: 'report_type', label: '接收报告类型', type: 'text', placeholder: '例如: Daily, Weekly' },
                  { name: 'is_active', label: '是否激活', type: 'checkbox' },
              ]
            },
            {
              key: 'SCHEDULED_REPORTS_CONFIG', title: '计划报告', idField: 'job_id',
              fields: [
                  { name: 'report_title_template', label: '报告标题模板', type: 'text', required: true },
                  { name: 'report_type', label: '报告类型', type: 'text', required: true },
                  { name: 'schedule_frequency', label: '调度频率', type: 'text', required: true },
                  { name: 'is_active', label: '是否激活', type: 'checkbox' },
              ]
            }
          ];
        },

        // 切换主二级Tab (e.g., 系统配置, 数据注册与管理)
        switchSubTab: function(subTabId) {
          if (this.activeSubTab === subTabId && this.isInitialized) return; // 避免不必要的重绘

          this.activeSubTab = subTabId;
          this.activeRegistryKey = null;

          document.querySelectorAll('.system-sub-tab').forEach(tab => {
              const isSelected = tab.dataset.subTab === subTabId;
              tab.classList.toggle('border-primary', isSelected);
              tab.classList.toggle('text-primary', isSelected);
              tab.classList.toggle('border-transparent', !isSelected);
              tab.classList.toggle('text-gray-500', !isSelected);
          });

          document.querySelectorAll('.system-sub-tab-content').forEach(content => {
              content.classList.toggle('hidden', content.id !== `system-tab-content-${subTabId}`);
          });
          
          // ✅ 核心修改：确保在切换子Tab之前，父容器已经渲染
          if (subTabId === 'registries') {
              const firstRegistryKey = this.registryConfigs[0]?.key;
              if(firstRegistryKey) this.switchRegistryTab(firstRegistryKey);
          } else if (subTabId === 'reports-mgmt') {
              this.loadReportConfigContent();
              const firstReportKey = this.reportConfigs[0]?.key;
              if(firstReportKey) this.switchRegistryTab(firstReportKey);
          } else {
              const container = document.getElementById(`system-tab-content-${subTabId}`);
              if(container) {
                  const tabElement = document.querySelector(`.system-sub-tab[data-sub-tab="${subTabId}"]`);
                  const tabTitle = tabElement ? tabElement.textContent.trim() : subTabId;
                  container.innerHTML = `<div class="p-8 bg-gray-50 rounded-lg"><h3 class="text-2xl font-semibold">${tabTitle}</h3><p class="mt-2 text-gray-500">此功能模块正在开发中...</p></div>`;
              }
          }
        },

        switchRegistryTab: function(registryKey) {
          if (this.activeRegistryKey === registryKey) return; // 避免重复加载
          this.activeRegistryKey = registryKey;
          
          document.querySelectorAll('.registry-tab').forEach(tab => {
              const isSelected = tab.dataset.registry === registryKey;
              tab.classList.toggle('border-primary', isSelected);
              tab.classList.toggle('text-primary', isSelected);
              tab.classList.toggle('border-transparent', !isSelected);
              tab.classList.toggle('text-gray-500', !isSelected);
          });
          
          this.loadRegistryData(registryKey);
        },

        // 通过键名查找注册表配置的辅助函数
        getRegistryConfig: function(registryKey) {
          return [...this.registryConfigs, ...this.reportConfigs].find(c => c.key === registryKey);
        }
      }
    }
  };
  window.addEventListener('load', () => App.init());
</script>
