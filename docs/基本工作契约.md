好的，Jason。这个要求非常非常重要，它体现了**迭代开发和版本控制的核心思想**。我完全理解并赞同。我们将把这条原则作为整个重构过程的“安全带”和“基石”。

这意味着，我的每一次代码输出，都将明确地声明它是在**哪一份您已提供并验证过的代码基础上**进行的修改，确保所有的变更都是**可追溯、可理解的演进**，而不是凭空的创造。

让我们将这条原则正式加入我们的设计基线中。

---

### **项目重构设计基线与需求清单 (v2.1 - 最终版)**

这份清单是我们所有后续工作的最终“契约”。

#### **0. 核心开发原则 (Core Development Principle)**

*   **0.1. 继承式发展 (Inherited Development)**: **(新增核心原则)** 所有新代码的构建和重构，**必须**明确基于**上一次由您提供或我们共同确认有效的代码版本**作为基础。每一次代码输出都应被视为对该基线的演进和增强，确保所有变更都是**增量式、可追索且逻辑连贯的**，严禁脱离上下文进行创造。

#### **1. 核心架构原则 (Architectural Principles)**

*   **1.1. 严格分层**: 遵从并扩展您现有的 `layerXX` 体系。
*   **1.2. 职责单一**: 每个 `.gs` 文件及其内部模块只负责一件核心任务。
*   **1.3. 动静分离**: 将**后台异步**任务与**前台同步**API在执行层面彻底分开，保障前端用户体验。

#### **2. 混合执行模式 (Hybrid Execution Model)**

*   **2.1. 本地与云端兼容**: 核心计算密集型服务的设计必须内建对本地(Apps Script)和云端(GCP)两种模式的支持。
*   **2.2. 全局开关控制**: 通过`Config.js`中的全局开关控制执行路径。
*   **2.3. 最大化代码复用**: 在两种模式下最大化地复用业务逻辑代码。

#### **3. 性能与成本优化 (Performance & Cost Optimization)**

*   **3.1. 批处理优先**: 所有对外部API和数据库的调用，必须优先采用批处理模式。
*   **3.2. 异步与解耦**: 必须利用`queue_tasks`集合作为缓冲池进行解耦。
*   **3.3. 数据库开销控制**:
    *   通过**预计算**和**分析快照**来最小化实时查询。
    *   所有更新操作必须采用**安全的合并更新**（使用`updateMask`）。
*   **3.4. 缓存策略**: 在适当的位置使用`CacheService`。

#### **4. 数据采集层重构 (Collection Layer Refactoring)**

*   **4.1. 双轮驱动模型**: 必须将采集逻辑拆分为**技术驱动 (`TechnologySourceDriver`)** 和 **公司驱动 (`CompanySourceDriver`)**。
*   **4.2. 独立文件实现**: 两个驱动器必须在独立的新文件中实现。
*   **4.3. 配置驱动**: 每个采集器必须通过读取内部配置来决定其工作范围。

#### **5. 服务与职责重组 (Service & Responsibility Realignment)**

*   **5.1. `DataProcessService` 瘦身**: 其唯一职责必须收缩为**处理任务队列**。
*   **5.2. `AnalysisService` 职责扩充**: 必须接收所有后台分析工作流的逻辑。
*   **5.3. API服务精简与合并**: 必须执行`RawDataStatsService` -> `SystemHealthStatsService` 和 `Admin/Config` -> `RegistryService`的合并重组。

#### **6. 公共能力抽象 (Utility Abstraction)**

*   **6.1. 引入`layer00`工具层**: 必须创建`layer00`作为最基础的层次。
*   **6.2. Prompt库**: 必须在`layer00.Prompts.gs`中集中管理所有AI Prompt模板。
*   **6.3. 辅助函数库**: 必须在`layer00.Helpers.gs`中集中管理所有全局共享的无状态工具函数。

#### **7. 命名与配置规范 (Naming & Configuration Convention)**

*   **7.1. 严格遵从最终版`Config.gs`**: 所有对Firestore集合的引用，必须通过带有**逻辑层次前缀**的`CONFIG.FIRESTORE_COLLECTIONS`键名进行。
*   **7.2. 去情报化命名**: 必须在所有新命名中，使用更中性、更技术化的词汇。
*   **7.3. 文件与模块命名对齐**: 所有文件和模块必须严格遵循我们最终确定的命名约定。

#### **8. 前端用户体验 (Frontend User Experience)**

*   **8.1. 快速响应**: 所有服务于前端的API（`layer04`）的设计必须以**快速响应**为首要目标。
*   **8.2. BFF (Backend for Frontend) 模式**: 必须通过`PresentationService`（或类似服务）为前端页面**预先准备好**干净、即插即用的数据。
*   **8.3. 异步任务反馈**: 对于用户触发的长时间运行任务，API必须**立即返回任务ID**，并提供**状态轮询接口**。

---

**基线确认**:

这份 v2.1 清单现在已经非常完整和严谨。它包含了从宏观架构、性能成本，到微观命名、开发原则的所有方面。**我将以这份清单作为我们之间唯一的、最终的共识**，并承诺我后续提供的所有代码，都将是**在您已提供的代码基础上，严格遵循这份清单所有原则的增量式实现**。

请您最后一次审阅，如果确认无误，我们就可以满怀信心地开始生成最终的代码了。
