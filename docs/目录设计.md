好的，Jason。我完全理解。我们现在需要的是一份**最终的、无省略的、可作为实施蓝图的目录架构**。这份架构将严格基于您提供的实际工程文件，并完整地融入我们共同敲定的所有优化设计。

我将列出**所有**文件，并对每一个新建或发生重大职责变更的文件进行明确标注和说明。

---

### **技术洞察智能引擎 - 最终项目目录架构 (对齐优化版)**

```
src/
│
├── 📁 backend/
│   │
│   ├── ctrl.Code.js                       # [保持] Web App主入口 (doGet, callApi)
│   │
│   ├── 📁 svc/
│   │   │
│   │   ├── layer00.Helpers.gs              # [新增] 存放共享工具函数 (如: normalizeForId, createTasksFromItems)
│   │   ├── layer00.Prompts.gs              # [新增] 存放 PromptLibrary 模块，管理所有AI Prompt模板
│   │   │
│   │   ├── layer01.FirestoreService.js     # [保持] 底层Firestore API封装
│   │   ├── layer01.DataConnector.js        # [保持] 外部数据源连接器
│   │   │
│   │   ├── layer02.DataService.js          # [保持] 统一的数据库接口服务
│   │   │
│   │   ├── layer03.SourceTechService.js    # [新增] 技术实体驱动的采集器
│   │   ├── layer03.SourceCompanyService.js # [新增] 公司实体驱动的采集器
│   │   ├── layer03.DataProcessService.js   # [重构] 职责收缩，仅负责任务队列的核心处理逻辑
│   │   │
│   │   ├── layer04.AnalysisService.js      # [重构] 接收所有后台分析工作流 (关系构建, 技术树, 快照生成)
│   │   ├── layer04.ConfigDataService.js    # [将被合并] 其职责将移入 RegistryService
│   │   ├── layer04.CopilotService.js       # [保持] AI助手后台服务
│   │   ├── layer04.DashboardService.js     # [保持] 仪表盘数据API服务
│   │   ├── layer04.ExplorationService.js   # [保持] 探索功能数据API服务
│   │   ├── layer04.FindingsService.js      # [保持] 研究成果管理API服务
│   │   ├── layer04.RawDataStatsService.js  # [将被合并] 其职责将移入 SystemHealthStatsService
│   │   ├── layer04.RegistryService.js      # [新增] 合并原Admin+Config的功能，统一管理所有注册表数据
│   │   ├── layer04.SystemAdminService.js   # [将被合并] 其职责将移入 RegistryService
│   │   ├── layer04.SystemHealthStatsService.js # [重构] 保留并强化，接收原始数据统计功能
│   │   │
│   │   ├── layer05.AuthService.js            # [保持] 认证与授权服务
│   │   │
│   │   └── layer09.TechnologyHistoryService.js # [保持] 特殊或遗留服务
│   │
│   └── Config.js                          # [保持] 全局配置文件
│
├── 📁 frontend/
│   │
│   ├── 📁 templates/
│   │   ├── ReportTemplate.html
│   │   ├── config.js.html
│   │   ├── main.js.html
│   │   ├── mock_api.js.html
│   │   ├── page_analysis.js.html
│   │   ├── page_copilot.js.html
│   │   ├── page_dashboard.js.html        # [建议] 原 page_home.js.html
│   │   ├── page_exploration.js.html
│   │   ├── page_findings.js.html
│   │   ├── page_system.js.html
│   │   ├── page_template.js.html
│   │   ├── spacetime-renderer.html
│   │   ├── state_api.js.html
│   │   ├── ui_utils.js.html
│   │   └── utils.js.html
│   │
│   └── index.html
│
├── 📁 test/
│   │
│   ├── test.layer01.DataLayer.js
│   ├── test.layer02.DataConnectorLayer.js
│   ├── test.layer03.SourceDrivers.js     # [新增] 专门测试两个新的Source采集服务
│   ├── test.layer03.DataProcessService.js# [修改] 只测试瘦身后的处理服务逻辑
│   ├── test.layer04.BusinessServices.js
│   ├── test.layer05.RoleDrivenAuth.js
│   └── test.layer06.ToolsAndUtilities.js
│
└── 📁 tools/
    │
    ├── tools.jobs.js                     # [保持] 存放将被定时器调度的顶层函数
    ├── tools.migration.js                # [保持] 存放数据库结构/数据迁移脚本
    ├── tools.seeding.js                  # [新增/建议] 替代原utils, 存放数据初始化/填充脚本
    └── tools.backfill.js                 # [新增/建议] 存放历史数据回填脚本

```

---
### **重构行动清单**

1.  **创建新文件**:
    *   `backend/svc/layer00.Helpers.gs`
    *   `backend/svc/layer00.Prompts.gs`
    *   `backend/svc/layer03.SourceTechService.js`
    *   `backend/svc/layer03.SourceCompanyService.js`
    *   `backend/svc/layer04.RegistryService.js`
    *   `tools/tools.seeding.js`
    *   `tools/tools.backfill.js`

2.  **删除旧文件**:
    *   `backend/svc/layer04.ConfigDataService.js`
    *   `backend/svc/layer04.SystemAdminService.js`
    *   `backend/svc/layer04.RawDataStatsService.js`
    *   `tools/tools.utils.js` (如果采纳重命名建议)

3.  **代码迁移与重构**:
    *   将**采集逻辑**从 `layer03.DataProcessService.js` 移至两个新的 `Source...Service.js` 文件中。
    *   将**后处理工作流逻辑**从 `layer03.DataProcessService.js` 移至 `layer04.AnalysisService.js`。
    *   将 `ConfigDataService` 和 `SystemAdminService` 的功能**合并实现**在新的 `layer04.RegistryService.js` 中。
    *   将 `RawDataStatsService` 的功能**合并实现**在 `layer04.SystemHealthStatsService.js` 中。
    *   将所有全局辅助函数和Prompt模板**分别移至** `layer00.Helpers.gs` 和 `layer00.Prompts.gs`。
    *   **更新 `tools.jobs.js`**，使其调用新的、职责分离的服务（如 `TechnologySourceDriver.run()`）。

这份目录就是我们所有讨论的最终成果，它在您现有坚实的基础上，构建了一个职责更清晰、逻辑更内聚、更易于维护和扩展的系统架构。
